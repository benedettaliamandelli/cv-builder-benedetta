<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CV Studio — Login</title>

<link rel="stylesheet" href="./styles.css"/>
<link rel="stylesheet" href="./fonts/fonts.css"/>

<!-- Tailwind + React -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase SDKs (safe to include even if you haven't configured keys yet) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Your auth+storage (Firebase first, then local fallback inside storage.firebase.js) -->
<script src="./auth.firebase.js"></script>
<script src="./storage.firebase.js"></script>
</head>
<body class="bg-neutral-100">
<div id="root"></div>

<script type="text/babel">
const {useEffect, useState} = React;

function detectFirebase(){
  // True if firebase initialized properly and Auth is wired
  const okSDK = !!(window.firebase && firebase.apps);
  const appCount = okSDK ? firebase.apps.length : 0;
  // If auth.firebase.js failed to initialize (bad/missing config), appCount stays 0
  return appCount > 0 && !!window.Auth;
}

function Login(){
  const [checking, setChecking] = useState(true);
  const [error, setError] = useState("");
  const hasFirebase = detectFirebase();

  useEffect(()=>{
    if(!window.Auth){
      // Fallback stub (guest only) if auth not present
      window.Auth = {
        onAuthChange: (fn)=>{ fn(null); return ()=>{}; },
        signInWithGoogle: async()=>{ throw new Error("Firebase not configured"); },
        signInWithApple: async()=>{ throw new Error("Firebase not configured"); },
        signOut: async()=>{}
      };
    }
    const off = Auth.onAuthChange((user)=>{
      if(user?.uid){
        location.replace('./home.html?uid=' + encodeURIComponent(user.uid));
      }else{
        setChecking(false);
      }
    });
    return off;
  },[]);

  async function google(){
    try{
      setError("");
      await Auth.signInWithGoogle();
      // onAuthChange will redirect on success
    }catch(e){
      setError(e?.message || "Google sign-in failed. If you haven't added Firebase config, use Guest.");
    }
  }
  async function apple(){
    try{
      setError("");
      await Auth.signInWithApple();
    }catch(e){
      setError(e?.message || "Apple sign-in failed. If you haven't added Firebase config, use Guest.");
    }
  }
  function guest(){
    location.href = './home.html?guest=1';
  }

  if(checking) return <div className="min-h-screen flex items-center justify-center text-neutral-600">Checking session…</div>;

  return (
    <div className="min-h-screen flex items-center justify-center px-4">
      <div className="card w-full max-w-md p-6">
        <div className="text-center mb-6">
          <div className="text-2xl font-semibold">CV Studio</div>
          <div className="text-sm text-neutral-600">Sign in to manage and export your CVs</div>
        </div>

        {!hasFirebase && (
          <div className="mb-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">
            Firebase not configured yet. You can continue as Guest now and set Firebase later.
          </div>
        )}

        {error && <div className="mb-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded p-2">{error}</div>}

        <div className="grid gap-2">
          <button className="btn" onClick={google} disabled={!hasFirebase}>Continue with Google</button>
          <button className="btn" onClick={apple} disabled={!hasFirebase}>Continue with Apple</button>
          <div className="text-center text-xs text-neutral-500 my-2">— or —</div>
          <button className="btn" onClick={guest}>Continue as Guest</button>
        </div>

        <div className="text-[11px] text-neutral-500 mt-4 leading-snug">
          In guest mode your CVs are saved locally in your browser.
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Login/>);
</script>
</body>
</html>