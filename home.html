<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CV Studio — Home</title>

<link rel="stylesheet" href="./styles.css"/>
<link rel="stylesheet" href="./fonts/fonts.css"/>

<!-- UI libs -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase SDKs (safe to include even if not configured yet) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Auth + Storage (Firebase first, then resilient local fallback) -->
<script src="./auth.firebase.js"></script>
<script src="./storage.firebase.js"></script>
<script src="./storage.local.js"></script>

<!-- Templates registry must be available before the Home app runs -->
<script src="./templates/default.template.js"></script>
<script src="./templates/minimal.template.js"></script>
</head>
<body class="bg-neutral-100">
<div id="root"></div>

<script type="text/babel">
const { useEffect, useState } = React;

/* ---------- helpers ---------- */
function isGuest() {
  try { return new URL(location.href).searchParams.get('guest') === '1'; }
  catch { return false; }
}

/* Track auth and mirror to window.AuthUser for non-React code */
function useAuth(){
  const [user, setUser] = useState(null);

  useEffect(()=>{
    // If Auth isn't available (no Firebase config), stay in guest mode
    if (!window.Auth || !window.Auth.onAuthChange) {
      setUser(null);
      window.AuthUser = null;
      return;
    }
    const off = window.Auth.onAuthChange(u => {
      setUser(u || null);
      window.AuthUser = u || null;
    });
    return off;
  },[]);

  return {
    user,
    signIn: window.Auth?.signInWithGoogle || (async()=>alert('Google sign-in unavailable (Firebase not configured). Use guest mode.')),
    signOut: window.Auth?.signOut || (async()=>{})
  };
}

function Home(){
  const { user, signIn, signOut } = useAuth();
  const [docs, setDocs] = useState([]);
  const [tpls, setTpls] = useState([]);
  const [loadingDocs, setLoadingDocs] = useState(true);
  const [err, setErr] = useState("");

  useEffect(()=>{
    try {
      setTpls(window.CV_TEMPLATES ? window.CV_TEMPLATES.list() : []);
    } catch(e) {
      console.warn('Templates not ready:', e);
      setTpls([]);
    }
  },[]);

  // guard: if not authenticated and not guest → bounce to login
  useEffect(()=>{
    const guest = isGuest();
    if (!user && !guest) {
      const t = setTimeout(()=>{ location.replace('./login.html'); }, 300);
      return ()=>clearTimeout(t);
    }
  }, [user]);

  async function refresh(){
    setLoadingDocs(true);
    setErr("");
    try {
      const all = await window.StorageAPI.list(user?.uid);
      setDocs(all);
    } catch (e) {
      console.warn('List failed:', e);
      setErr("Unable to load your CVs. You can still create a new one.");
      setDocs([]);
    } finally {
      setLoadingDocs(false);
    }
  }
  useEffect(()=>{ refresh(); }, [user]);

  async function createNew(){
    const name = prompt("Document name:", "Default");
    if (name === null) return;
    const trimmed = name.trim();
    if (!trimmed) { alert("Please enter a name"); return; }

    // Template registry (defensive)
    const reg = window.CV_TEMPLATES;
    const firstId = (reg && reg.list && reg.list()[0]?.id) || 'default';
    const tpl = (reg && reg.get && reg.get(firstId)) || { seed: ()=> ({ _orders:{ left:[], right:[] }, header:{ name:"JOHN DOE" } }) };
    const payload = tpl.seed ? tpl.seed() : { _orders:{ left:[], right:[] }, header:{ name:"JOHN DOE" } };

    try {
      await window.StorageAPI.save(trimmed, payload, user?.uid);
    } catch (e) {
      // localStorage blocked or quota → continue in-memory
      console.warn('Save failed (continuing):', e);
    }

    const params = new URLSearchParams();
    params.set('doc', trimmed);
    if (user?.uid) params.set('uid', user.uid);
    if (isGuest()) params.set('guest','1');
    location.href = './editor.html?' + params.toString();
  }

  function openDoc(n){
    const params = new URLSearchParams();
    params.set('doc', n);
    if (user?.uid) params.set('uid', user.uid);
    if (isGuest()) params.set('guest','1');
    location.href = './editor.html?' + params.toString();
  }

  async function removeDoc(n){
    if (!confirm(`Delete "${n}"?`)) return;
    try { await window.StorageAPI.remove(n, user?.uid); }
    finally { refresh(); }
  }

  return (
    <div className="max-w-4xl mx-auto p-6">
      <header className="flex items-center gap-3 mb-6">
        <div className="text-xl font-semibold">CV Studio</div>
        <div className="ml-auto">
          {user ? (
            <div className="flex items-center gap-2">
              <span className="text-sm text-neutral-600">Hello {user.displayName || user.email}</span>
              <button className="btn" onClick={signOut}>Sign out</button>
            </div>
          ) : (
            <div className="flex items-center gap-2">
              <a className="btn" href="./login.html">Go to login</a>
              <button className="btn" onClick={signIn}>Sign in with Google</button>
              <a className="btn" href="./home.html?guest=1">Guest mode</a>
            </div>
          )}
        </div>
      </header>

      <section className="card p-4 mb-6">
        <div className="font-semibold mb-2">Templates</div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          {tpls.map(t=>(
            <div key={t.id} className="border rounded p-3">
              <div className="font-medium">{t.name}</div>
              <div className="text-sm text-neutral-600">{t.desc}</div>
              <div className="mt-2 text-xs text-neutral-500">id: {t.id}</div>
            </div>
          ))}
          {tpls.length===0 && <div className="text-sm text-neutral-500">Loading templates…</div>}
        </div>
        <div className="mt-3">
          <button className="btn-primary" onClick={createNew}>+ Create CV</button>
        </div>
      </section>

      <section className="card p-4">
        <div className="font-semibold mb-2">Your CVs</div>
        {err && <div className="mb-2 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">{err}</div>}
        {loadingDocs ? (
          <div className="text-sm text-neutral-500">Loading…</div>
        ) : (
          <div className="grid gap-2">
            {docs.length===0 && <div className="text-sm text-neutral-500">No documents yet.</div>}
            {docs.map(n=>(
              <div key={n} className="flex items-center justify-between border rounded p-2">
                <div>{n}</div>
                <div className="flex items-center gap-2">
                  <button className="btn" onClick={()=>openDoc(n)}>Open</button>
                  <button className="btn-danger" onClick={()=>removeDoc(n)}>Delete</button>
                </div>
              </div>
            ))}
          </div>
        )}
      </section>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Home/>);
</script>
</body>
</html>