<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CV Studio — Home</title>

<link rel="stylesheet" href="./styles.css"/>
<link rel="stylesheet" href="./fonts/fonts.css"/>

<!-- UI libs -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase SDKs (safe to include even if not configured yet) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Auth + Storage (Firebase first, then resilient local fallback) -->
<script src="./auth.firebase.js"></script>
<script src="./storage.firebase.js"></script>
<script src="./storage.local.js"></script>

<!-- Templates registry must be available before the Home app runs -->
<script src="./templates/default.js?v=20251019"></script>
<script src="./templates/minimal.js?v=20251019"></script>

<!-- === Safety CSS for buttons/cards (kept tiny) === -->
<style>
  .btn{ padding:.4rem .7rem; border:1px solid #e5e7eb; border-radius:.5rem; background:white; }
  .btn-primary{ padding:.45rem .8rem; border-radius:.5rem; background:#111827; color:white; }
  .btn-danger{ padding:.4rem .7rem; border:1px solid #fecaca; background:#fee2e2; color:#991b1b; border-radius:.5rem; }
  .card{ background:white; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .diag{position:fixed;right:8px;bottom:8px;background:#111827;color:#fff;border-radius:8px;padding:8px 10px;font:12px/1.2 ui-sans-serif;opacity:.9;z-index:9999}
</style>
</head>
<body class="bg-neutral-100">
<div id="root"></div>


<!-- === Fallbacks: only run if external scripts didn't register things === -->
<script>
  (function(){
    // 2a) StorageAPI shim (localStorage) if not provided by your storage scripts
    if (!window.StorageAPI) {
      window.StorageAPI = {
        async list(){ return Object.keys(localStorage).filter(k=>k.startsWith('cvdoc:')).map(k=>k.replace('cvdoc:','')).sort(); },
        async save(name, data){ localStorage.setItem('cvdoc:'+name, JSON.stringify(data)); return true; },
        async load(name){ const raw=localStorage.getItem('cvdoc:'+name); return raw? JSON.parse(raw): null; },
        async remove(name){ localStorage.removeItem('cvdoc:'+name); return true; }
      };
      console.warn('[home] StorageAPI fallback active (Firebase/local scripts not ready).');
    }

    // 2b) CV_TEMPLATES shim if your template files didn’t register
    var reg = window.CV_TEMPLATES;
    var empty = !reg || !reg._all || Object.keys(reg._all).length===0;
    if (empty) {
      window.CV_TEMPLATES = {
        _all:{},
        list(){ return Object.values(this._all).map(({id,name,desc})=>({id,name,desc})); },
        get(id){ return this._all[id]; }
      };
      (function(){ // minimal default template
        const id='default', name='Default (Fallback)', desc='Inline fallback template';
        function seed(){
          return {
            header:{ name:"JOHN DOE", role:"", email:"", phone:"", residence:"", birthdate:"", avatar:"" },
            summary:"",
            sectionNames:{ experience:"Experience", education:"Education", volunteering:"Volunteering", projects:"Projects", certifications:"Certifications", awards:"Awards", skills:"Skills", languages:"Languages", strengths:"Strengths", hobbies:"Hobbies", online:"Online", laws:"Laws" },
            experience:[], education:[], volunteering:[], projects:[], certifications:[], awards:[], skills:[], languages:[], strengths:[], hobbies:[],
            online:{}, laws:["I authorize the processing of personal data in accordance with GDPR 2016/679."],
            _orders:{ left:["laws","skills","languages","strengths","hobbies","online","certifications","awards"], right:["experience","education","volunteering","projects"] },
            _theme:{ accent:"#2563eb", fontSize:11, lineHeight:1.45 }
          };
        }
        function migrate(old){ const s=seed(); return {...s, ...old, _orders:(old&&old._orders)||s._orders}; }
        window.CV_TEMPLATES._all[id] = { id, name, desc, seed, migrate };
      })();
      console.warn('[home] CV_TEMPLATES fallback active (templates not loaded).');
    }

    // 2c) small diagnostics badge (helps confirm what loaded on Pages)
    setTimeout(function(){
      try{
        var t = window.CV_TEMPLATES?.list?.().length ?? 0;
        var el = document.createElement('div');
        el.className = 'diag';
        el.textContent = 'tpls:'+t+' guest:'+(new URL(location.href).searchParams.get('guest')==='1');
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), 6000);
      }catch{}
    }, 0);
  })();
</script>

<script type="text/babel">
const { useEffect, useState } = React;

/* ---------- helpers ---------- */
function isGuest() {
  try { return new URL(location.href).searchParams.get('guest') === '1'; }
  catch { return false; }
}

/* Track auth and mirror to window.AuthUser for non-React code */
function useAuth(){
  const [user, setUser] = useState(null);

  useEffect(()=>{
    // If Auth isn't available (no Firebase config), stay in guest mode
    if (!window.Auth || !window.Auth.onAuthChange) {
      setUser(null);
      window.AuthUser = null;
      return;
    }
    const off = window.Auth.onAuthChange(u => {
      setUser(u || null);
      window.AuthUser = u || null;
    });
    return off;
  },[]);

  return {
    user,
    signIn: window.Auth?.signInWithGoogle || (async()=>alert('Google sign-in unavailable (Firebase not configured). Use guest mode.')),
    signOut: window.Auth?.signOut || (async()=>{})
  };
}

function Home(){
  const { user, signIn, signOut } = useAuth();
  const [docs, setDocs] = useState([]);
  const [tpls, setTpls] = useState([]);
  const [loadingDocs, setLoadingDocs] = useState(true);
  const [err, setErr] = useState("");

  useEffect(()=>{
    try {
      setTpls(window.CV_TEMPLATES ? window.CV_TEMPLATES.list() : []);
    } catch(e) {
      console.warn('Templates not ready:', e);
      setTpls([]);
    }
  },[]);

  // guard: if not authenticated and not guest → bounce to login
  useEffect(()=>{
    const guest = isGuest();
    if (!user && !guest) {
      const t = setTimeout(()=>{ location.replace('./login.html'); }, 300);
      return ()=>clearTimeout(t);
    }
  }, [user]);

  async function refresh(){
    setLoadingDocs(true);
    setErr("");
    try {
      const all = await window.StorageAPI.list(user?.uid);
      setDocs(all);
    } catch (e) {
      console.warn('List failed:', e);
      setErr("Unable to load your CVs. You can still create a new one.");
      setDocs([]);
    } finally {
      setLoadingDocs(false);
    }
  }
  useEffect(()=>{ refresh(); }, [user]);

  async function createNew(){
    const name = prompt("Document name:", "Default");
    if (name === null) return;
    const trimmed = name.trim();
    if (!trimmed) { alert("Please enter a name"); return; }

    // Template registry (defensive)
    const reg = window.CV_TEMPLATES;
    const firstId = (reg && reg.list && reg.list()[0]?.id) || 'default';
    const tpl = (reg && reg.get && reg.get(firstId)) || { seed: ()=> ({ _orders:{ left:[], right:[] }, header:{ name:"JOHN DOE" } }) };
    const payload = tpl.seed ? tpl.seed() : { _orders:{ left:[], right:[] }, header:{ name:"JOHN DOE" } };

    try {
      await window.StorageAPI.save(trimmed, payload, user?.uid);
    } catch (e) {
      // localStorage blocked or quota → continue in-memory
      console.warn('Save failed (continuing):', e);
    }

    const params = new URLSearchParams();
    params.set('doc', trimmed);
    if (user?.uid) params.set('uid', user.uid);
    if (isGuest()) params.set('guest','1');
    location.href = './editor.html?' + params.toString();
  }

  function openDoc(n){
    const params = new URLSearchParams();
    params.set('doc', n);
    if (user?.uid) params.set('uid', user.uid);
    if (isGuest()) params.set('guest','1');
    location.href = './editor.html?' + params.toString();
  }

  async function removeDoc(n){
    if (!confirm(`Delete "${n}"?`)) return;
    try { await window.StorageAPI.remove(n, user?.uid); }
    finally { refresh(); }
  }

  return (
    <div className="max-w-4xl mx-auto p-6">
      <header className="flex items-center gap-3 mb-6">
        <div className="text-xl font-semibold">CV Studio</div>
        <div className="ml-auto">
          {user ? (
            <div className="flex items-center gap-2">
              <span className="text-sm text-neutral-600">Hello {user.displayName || user.email}</span>
              <button className="btn" onClick={signOut}>Sign out</button>
            </div>
          ) : (
            <div className="flex items-center gap-2">
              <a className="btn" href="./login.html">Go to login</a>
              <button className="btn" onClick={signIn}>Sign in with Google</button>
              <a className="btn" href="./home.html?guest=1">Guest mode</a>
            </div>
          )}
        </div>
      </header>

      <section className="card p-4 mb-6">
        <div className="font-semibold mb-2">Templates</div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          {tpls.map(t=>(
            <div key={t.id} className="border rounded p-3">
              <div className="font-medium">{t.name}</div>
              <div className="text-sm text-neutral-600">{t.desc}</div>
              <div className="mt-2 text-xs text-neutral-500">id: {t.id}</div>
            </div>
          ))}
          {tpls.length===0 && <div className="text-sm text-neutral-500">Loading templates…</div>}
        </div>
        <div className="mt-3">
          <button className="btn-primary" onClick={createNew}>+ Create CV</button>
        </div>
      </section>

      <section className="card p-4">
        <div className="font-semibold mb-2">Your CVs</div>
        {err && <div className="mb-2 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">{err}</div>}
        {loadingDocs ? (
          <div className="text-sm text-neutral-500">Loading…</div>
        ) : (
          <div className="grid gap-2">
            {docs.length===0 && <div className="text-sm text-neutral-500">No documents yet.</div>}
            {docs.map(n=>(
              <div key={n} className="flex items-center justify-between border rounded p-2">
                <div>{n}</div>
                <div className="flex items-center gap-2">
                  <button className="btn" onClick={()=>openDoc(n)}>Open</button>
                  <button className="btn-danger" onClick={()=>removeDoc(n)}>Delete</button>
                </div>
              </div>
            ))}
          </div>
        )}
      </section>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Home/>);
</script>
</body>
</html>