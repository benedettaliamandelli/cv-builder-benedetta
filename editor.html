<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CV Studio — Editor</title>

<link rel="stylesheet" href="./styles.css"/>
<link rel="stylesheet" href="./fonts/fonts.css"/>

<!-- Minimal safety styles (kept tiny, does not override your CSS) -->
<style>
  :root { --rule:#d1d5db; }
  .icon{ display:inline-block; width:1em; height:1em; background:currentColor; }
  .circle-icon{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:9999px; background:#e5e7eb; color:#2563eb; }
  .logo{ width:32px; height:32px; border-radius:9999px; overflow:hidden; border:1px solid #e5e7eb; flex:0 0 auto;}
  .btn{ padding:.4rem .7rem; border:1px solid #e5e7eb; border-radius:.5rem; background:white; }
  .btn-primary{ padding:.45rem .8rem; border-radius:.5rem; background:#111827; color:white; }
  .btn-danger{ padding:.4rem .7rem; border:1px solid #fecaca; background:#fee2e2; color:#991b1b; border-radius:.5rem; }
  .chip{ padding:.15rem .45rem; border:1px solid #e5e7eb; border-radius:.4rem; background:white; font-size:.8rem; }
  .input{ border:1px solid #e5e7eb; border-radius:.4rem; padding:.35rem .5rem; background:white; }
  .range{ width:140px; }
  .color-swatch{ width:36px; height:28px; padding:0; border:1px solid #e5e7eb; border-radius:.4rem; }
  .card{ background:white; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .title-divider{ height:1px; background:var(--rule); margin:.25rem 0 .5rem; }
  .meta{ color:#6b7280; }
  @media print{
    body.print-mode .sheet{ break-inside: avoid; box-shadow:none !important; }
    #toolbar, #leftPane{ display:none!important; }
    body{ background:white!important; }
    @page{ size:A4; margin:14mm; }
  }
  .sheet{ box-shadow:0 10px 25px rgba(0,0,0,.06); background:white; }
  .sidebar-scroll{ max-height: calc(100vh - 140px); overflow:auto; padding-bottom: 24px; }
</style>

<!-- UI libs -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase SDKs (ok even if not configured yet) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Storage/Auth -->
<script src="./auth.firebase.js"></script>
<script src="./storage.firebase.js"></script>
<script src="./storage.local.js"></script>

<!-- Templates: MUST load before the React app -->
<script src="./templates/default.js?v=20251019"></script>
<script src="./templates/minimal.js?v=20251019"></script>
</head>
<body class="bg-neutral-100">
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect} = React;

/* -------- utils -------- */
const rid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const param = (k, d=null)=> { try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{return d;} };
const uid  = param('uid', null);
const docName = param('doc','Default');

/* guard: ensure template registry exists */
function safeDefaultSeed(){
  const reg = window.CV_TEMPLATES;
  try{
    const tpl = reg?.get?.('default');
    if (tpl?.seed) return tpl.seed();
  }catch(e){}
  // minimal blank seed if templates failed to load
  return {
    header:{ name:"JOHN DOE", role:"", email:"", phone:"", residence:"", birthdate:"", avatar:"" },
    summary:"",
    sectionNames:{ experience:"Experience", education:"Education", volunteering:"Volunteering", projects:"Projects", certifications:"Certifications", awards:"Awards", skills:"Skills", languages:"Languages", strengths:"Strengths", hobbies:"Hobbies", online:"Online", laws:"Laws" },
    experience:[], education:[], volunteering:[], projects:[], certifications:[], awards:[], skills:[], languages:[], strengths:[], hobbies:[],
    online:{}, laws:[],
    _orders:{ left:["laws","skills","languages","strengths","hobbies","online","certifications","awards"], right:["experience","education","volunteering","projects"] },
    _theme:{ accent:"#2563eb", fontSize:11, lineHeight:1.45 }
  };
}

/* image upload */
function pickImage(cb){
  const i=document.createElement('input'); i.type='file'; i.accept='image/*';
  i.onchange=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=> cb(String(r.result)); r.readAsDataURL(f);
  };
  i.click();
}

/* icon as color-following mask */
function Icon({name, className="", style={}}){
  if(!name) return null;
  const s = { ...style };
  const cls = `icon ${className}`;
  return <span className={cls} style={{...s, WebkitMask:`url(./icons/${name}.svg) center/contain no-repeat`, mask:`url(./icons/${name}.svg) center/contain no-repeat`}}/>;
}

/* fonts presets come from /fonts/fonts.css variables */
const FONT_PRESETS = [
  {label:"Default (Inter)", heading:"var(--font-inter)", body:"var(--font-inter)", meta:"var(--font-inter)", hWeight:600, subWeight:500},
  {label:"Serif Head / Sans Body", heading:"var(--font-serif)", body:"var(--font-system)", meta:"var(--font-system)", hWeight:600, subWeight:500},
  {label:"System Clean", heading:"var(--font-system)", body:"var(--font-system)", meta:"var(--font-system)", hWeight:600, subWeight:500},
];

/* -------- storage -------- */
async function loadDoc(){
  const data = await StorageAPI.load(docName, uid);
  return data || safeDefaultSeed();
}
async function saveDoc(data){ return StorageAPI.save(docName, data, uid); }

/* -------- main app -------- */
function App(){
  const [state,setState] = useState(null);
  const [accent,setAccent] = useState("#2563eb");
  const [fontSize,setFontSize] = useState(11);
  const [lineHeight,setLineHeight] = useState(1.45);
  const [headingFont,setHeadingFont] = useState(FONT_PRESETS[0].heading);
  const [bodyFont,setBodyFont] = useState(FONT_PRESETS[0].body);
  const [metaFont,setMetaFont] = useState(FONT_PRESETS[0].meta);
  const [hWeight,setHWeight] = useState(FONT_PRESETS[0].hWeight);
  const [subWeight,setSubWeight] = useState(FONT_PRESETS[0].subWeight);

  useEffect(()=>{(async()=>{
    try{
      const d=await loadDoc();
      applySeed(d);
    }catch(e){
      console.error('Load failed, using blank seed', e);
      applySeed(safeDefaultSeed());
    }
  })();},[]);

  function applySeed(d){
    setState(d);
    if(d._theme){
      const t=d._theme;
      setAccent(t.accent||"#2563eb");
      setFontSize(t.fontSize||11);
      setLineHeight(t.lineHeight||1.45);
      setHeadingFont(t.headingFont||FONT_PRESETS[0].heading);
      setBodyFont(t.bodyFont||FONT_PRESETS[0].body);
      setMetaFont(t.metaFont||FONT_PRESETS[0].meta);
      setHWeight(t.hWeight ?? 600);
      setSubWeight(t.subWeight ?? 500);
    }
  }

  if(!state) return <div className="p-6">Loading…</div>;

  /* move items in arrays */
  function moveItem(arrKey, idx, dir){
    setState(s=>{
      const arr=[...s[arrKey]];
      const j = dir==='up'? idx-1 : idx+1;
      if(j<0 || j>=arr.length) return s;
      [arr[idx],arr[j]]=[arr[j],arr[idx]];
      return {...s, [arrKey]:arr};
    });
  }

  /* move sections in column (up/down) or swap column */
  function moveSection(col, key, dir){
    setState(s=>{
      const left=[...s._orders.left], right=[...s._orders.right];
      let arr = col==='left'? left : right;
      const i = arr.indexOf(key); if(i===-1) return s;
      if(dir==='swap'){
        arr.splice(i,1);
        (col==='left'? right:left).splice(0,0,key);
      }else{
        const j = dir==='up'? i-1 : i+1;
        if(j<0 || j>=arr.length) return s;
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return {...s, _orders:{left, right}};
    });
  }

  /* section bar */
  function SectionBar({name,label,col}){
    return (
      <div className="flex items-center justify-between mb-1">
        <div className="uppercase tracking-widest text-xs" style={{color:accent, fontFamily:headingFont, fontWeight:hWeight}}>{label}</div>
        <div className="flex items-center gap-1">
          <button className="chip" title="Move up" onClick={()=>moveSection(col,name,'up')}>↑</button>
          <button className="chip" title="Move down" onClick={()=>moveSection(col,name,'down')}>↓</button>
          <button className="chip" title="Swap column" onClick={()=>moveSection(col,name,'swap')}>⇆</button>
        </div>
      </div>
    );
  }

  /* auto-logo by keyword map */
  const logoMap = React.useRef(null);
  useEffect(()=>{ fetch('./images/logos.json').then(r=>r.json()).then(j=>logoMap.current=j).catch(()=>{}); },[]);
  function guessLogo(word){
    const map = logoMap.current || {}; if(!word) return "";
    const k = word.toLowerCase();
    const hit = Object.keys(map).find(key => k.includes(key));
    return hit ? ('./images/'+map[hit]) : "";
  }
  /* renderers — icons colored by currentColor (inherit accent) */
  const R = {
    education:(col)=>(
      <section className="mb-6">
        <SectionBar name="education" label={state.sectionNames.education} col={col}/>
        <div className="title-divider"></div>
        {state.education.map((ed,i)=>(
          <div key={ed.id} className="mb-3" style={{fontFamily:bodyFont}}>
            <div className="flex justify-between items-baseline">
              <div className="mb-0.5" style={{fontWeight:hWeight}}>{ed.degree}</div>
              {/* right-aligned date */}
              <div className="text-sm meta">{ed.period}{ed.gpa?`  |  GPA ${ed.gpa}`:""}</div>
            </div>
            <div className="text-sm"><span style={{color:accent}}>{ed.school}</span></div>
            <div className="text-sm meta mt-0.5 inline-flex items-center gap-2" style={{color:"#6b7280"}}>
              <Icon name="location" className="w-4 h-4" style={{color:accent}}/> {ed.location}
            </div>

            {/* inline item controls */}
            <div className="mt-1 flex gap-1">
              <button className="chip" onClick={()=>moveItem('education',i,'up')}>↑</button>
              <button className="chip" onClick={()=>moveItem('education',i,'down')}>↓</button>
              <button className="chip danger" onClick={()=>setState(s=>({...s,education:s.education.filter(x=>x.id!==ed.id)}))}>Delete</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>setState(s=>({...s,education:[...s.education,{id:rid(),degree:"",school:"",period:"",location:"",gpa:""}]}))}>+ Add education</button>
      </section>
    ),
    experience:(col)=>(
      <section className="mb-6">
        <SectionBar name="experience" label={state.sectionNames.experience} col={col}/>
        <div className="title-divider"></div>
        {state.experience.map((ex,i)=>{
          const auto = (!ex.logo && guessLogo(ex.company)) || "";
          const logo = ex.logo || auto;
          return (
            <div key={ex.id} className="mb-4" style={{fontFamily:bodyFont}}>
              <div className="flex items-start gap-3">
                {logo ? <div className="logo mt-0.5"><img src={logo} className="w-full h-full object-cover" alt=""/></div> : null}
                <div className="flex-1 min-w-0">
                  <div className="flex items-baseline justify-between gap-2">
                    <div style={{fontWeight:hWeight}}>{ex.title}</div>
                    <div className="text-sm meta">{ex.period}</div>
                  </div>
                  <div className="text-sm"><span style={{color:accent}}>{ex.company}</span></div>
                  <div className="text-sm meta mt-0.5 inline-flex items-center gap-2">
                    <Icon name="location" className="w-4 h-4" style={{color:accent}}/> {ex.location}
                  </div>
                  {(ex.bullets||[]).length>0 && <ul className="list-disc pl-5 mt-2 text-sm text-neutral-800">{ex.bullets.map((b,j)=><li key={j}>{b}</li>)}</ul>}
                  <div className="mt-1 flex gap-1">
                    <button className="chip" onClick={()=>moveItem('experience',i,'up')}>↑</button>
                    <button className="chip" onClick={()=>moveItem('experience',i,'down')}>↓</button>
                    <button className="chip" onClick={()=>pickImage(url=>setState(s=>{const a=[...s.experience];a[i]={...a[i],logo:url};return {...s,experience:a};}))}>Logo</button>
                    {ex.logo && <button className="chip" onClick={()=>setState(s=>{const a=[...s.experience];a[i]={...a[i],logo:""};return {...s,experience:a};})}>Remove logo</button>}
                    <button className="chip danger" onClick={()=>setState(s=>({...s,experience:s.experience.filter(x=>x.id!==ex.id)}))}>Delete</button>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
        <button className="btn" onClick={()=>setState(s=>({...s,experience:[...s.experience,{id:rid(),title:"",company:"",period:"",location:"",logo:"",bullets:[]}]}))}>+ Add experience</button>
      </section>
    ),
    volunteering:(col)=>(
      <section className="mb-6">
        <SectionBar name="volunteering" label={state.sectionNames.volunteering} col={col}/>
        <div className="title-divider"></div>
        {state.volunteering.map((v,i)=>{
          const auto = (!v.logo && guessLogo(v.org)) || "";
          const logo = v.logo || auto;
          return (
            <div key={v.id} className="mb-4" style={{fontFamily:bodyFont}}>
              <div className="flex items-start gap-3">
                {logo ? <div className="logo mt-0.5"><img src={logo} className="w-full h-full object-cover" alt=""/></div> : null}
                <div className="flex-1 min-w-0">
                  <div className="flex items-baseline justify-between gap-2">
                    <div style={{fontWeight:hWeight}}>{v.role}</div>
                    <div className="text-sm meta">{v.period}</div>
                  </div>
                  <div className="text-sm"><span style={{color:accent}}>{v.org}</span></div>
                  <div className="text-sm meta mt-0.5 inline-flex items-center gap-2">
                    <Icon name="location" className="w-4 h-4" style={{color:accent}}/> {v.location}
                  </div>
                  {(v.bullets||[]).length>0 && <ul className="list-disc pl-5 mt-2 text-sm text-neutral-800">{v.bullets.map((b,j)=><li key={j}>{b}</li>)}</ul>}
                  <div className="mt-1 flex gap-1">
                    <button className="chip" onClick={()=>moveItem('volunteering',i,'up')}>↑</button>
                    <button className="chip" onClick={()=>moveItem('volunteering',i,'down')}>↓</button>
                    <button className="chip" onClick={()=>pickImage(url=>setState(s=>{const a=[...s.volunteering];a[i]={...a[i],logo:url};return {...s,volunteering:a};}))}>Logo</button>
                    {v.logo && <button className="chip" onClick={()=>setState(s=>{const a=[...s.volunteering];a[i]={...a[i],logo:""};return {...s,volunteering:a};})}>Remove logo</button>}
                    <button className="chip danger" onClick={()=>setState(s=>({...s,volunteering:s.volunteering.filter(x=>x.id!==v.id)}))}>Delete</button>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
        <button className="btn" onClick={()=>setState(s=>({...s,volunteering:[...s.volunteering,{id:rid(),role:"",org:"",period:"",location:"",logo:"",bullets:[]}]}))}>+ Add volunteering</button>
      </section>
    ),
    projects:(col)=>(
      <section className="mb-6">
        <SectionBar name="projects" label={state.sectionNames.projects} col={col}/>
        <div className="title-divider"></div>
        {state.projects.map((p,i)=>(
          <div key={p.id} className="mb-4" style={{fontFamily:bodyFont}}>
            <div className="flex items-baseline justify-between gap-2">
              <div style={{fontWeight:hWeight}}>{p.name}</div>
              <div className="text-sm meta">{p.period}</div>
            </div>
            <div className="meta text-sm flex items-center gap-4" style={{color:"#6b7280"}}>
              <span className="inline-flex items-center gap-2"><Icon name="location" className="w-4 h-4" style={{color:accent}}/>{p.location}</span>
            </div>
            {p.domain && <div className="mt-1" style={{color:accent, fontWeight:hWeight}}>{p.domain}</div>}
            {(p.bullets||[]).length>0 && <ul className="list-disc pl-5 mt-2 text-sm text-neutral-800">{p.bullets.map((b,j)=><li key={j}>{b}</li>)}</ul>}
            <div className="mt-1 flex gap-1">
              <button className="chip" onClick={()=>moveItem('projects',i,'up')}>↑</button>
              <button className="chip" onClick={()=>moveItem('projects',i,'down')}>↓</button>
              <button className="chip danger" onClick={()=>setState(s=>({...s,projects:s.projects.filter(x=>x.id!==p.id)}))}>Delete</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>setState(s=>({...s,projects:[...s.projects,{id:rid(),name:"",domain:"",period:"",location:"",bullets:[]}]}))}>+ Add project</button>
      </section>
    ),
    certifications:(col)=>(
      <section className="mb-6">
        <SectionBar name="certifications" label={state.sectionNames.certifications} col={col}/>
        <div className="title-divider"></div>
        {state.certifications.map((c,i)=>(
          <div key={c.id} className="flex items-start gap-3 mb-3" style={{fontFamily:bodyFont}}>
            {(c.logo) ? <div className="logo mt-0.5"><img src={c.logo} className="w-full h-full object-cover"/></div>
                      : (c.icon ? <span className="circle-icon mt-0.5" style={{color:accent}}><Icon name={c.icon} className="w-4 h-4"/></span> : null)}
            <div className="flex-1 min-w-0">
              <div style={{color:accent}}>{c.line1}</div>
              {c.line2 && <div className="text-neutral-900">{c.line2}</div>}
              <div className="mt-1 flex gap-1">
                <button className="chip" onClick={()=>moveItem('certifications',i,'up')}>↑</button>
                <button className="chip" onClick={()=>moveItem('certifications',i,'down')}>↓</button>
                <button className="chip" onClick={()=>pickImage(url=>setState(s=>{const a=[...s.certifications];a[i]={...a[i],logo:url,icon:""};return {...s,certifications:a};}))}>Logo</button>
                {c.logo && <button className="chip" onClick={()=>setState(s=>{const a=[...s.certifications];a[i]={...a[i],logo:""};return {...s,certifications:a};})}>Remove logo</button>}
                <button className="chip danger" onClick={()=>setState(s=>({...s,certifications:s.certifications.filter(x=>x.id!==c.id)}))}>Delete</button>
              </div>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>setState(s=>({...s,certifications:[...s.certifications,{id:rid(),icon:"certificate",logo:"",line1:"",line2:""}]}))}>+ Add certification</button>
      </section>
    ),
    awards:(col)=>(
      <section className="mb-6">
        <SectionBar name="awards" label={state.sectionNames.awards} col={col}/>
        <div className="title-divider"></div>
        {state.awards.map((a,i)=>(
          <div key={a.id} className="flex items-start gap-3 mb-3" style={{fontFamily:bodyFont}}>
            {a.logo ? <div className="logo mt-0.5"><img src={a.logo} className="w-full h-full object-cover"/></div>
                    : (a.icon ? <span className="circle-icon mt-0.5" style={{color:accent}}><Icon name={a.icon} className="w-4 h-4"/></span> : null)}
            <div className="flex-1 min-w-0">
              <div className="text-neutral-900" style={{fontWeight:600}}>{a.line1}</div>
              {a.line2 && <div className="text-neutral-900">{a.line2}</div>}
              <div className="mt-1 flex gap-1">
                <button className="chip" onClick={()=>moveItem('awards',i,'up')}>↑</button>
                <button className="chip" onClick={()=>moveItem('awards',i,'down')}>↓</button>
                <button className="chip" onClick={()=>pickImage(url=>setState(s=>{const x=[...s.awards];x[i]={...x[i],logo:url,icon:""};return {...s,awards:x};}))}>Logo</button>
                {a.logo && <button className="chip" onClick={()=>setState(s=>{const x=[...s.awards];x[i]={...x[i],logo:""};return {...s,awards:x};})}>Remove logo</button>}
                <button className="chip danger" onClick={()=>setState(s=>({...s,awards:s.awards.filter(x=>x.id!==a.id)}))}>Delete</button>
              </div>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>setState(s=>({...s,awards:[...s.awards,{id:rid(),icon:"award",logo:"",line1:"",line2:""}]}))}>+ Add award</button>
      </section>
    ),
    skills:(col)=>(
      <section className="mb-6">
        <SectionBar name="skills" label={state.sectionNames.skills} col={col}/>
        <div className="title-divider"></div>
        {state.skills.map((g,i)=>(
          <div key={i} className="mb-3">
            <div className="text-sm" style={{fontFamily:headingFont, fontWeight:400}}>{g.group}</div>
            <div className="mt-1 flex flex-wrap gap-2" style={{fontFamily:metaFont}}>
              {(g.items||[]).map((s,j)=><span key={j} className="tag">{s}</span>)}
            </div>
            <div className="mt-1 flex gap-1">
              <button className="chip" onClick={()=>moveItem('skills',i,'up')}>↑</button>
              <button className="chip" onClick={()=>moveItem('skills',i,'down')}>↓</button>
              <button className="chip danger" onClick={()=>setState(s=>({...s,skills:s.skills.filter((_,j)=>j!==i)}))}>Delete group</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>setState(s=>({...s,skills:[...s.skills,{group:"",items:[]}] }))}>+ Add group</button>
      </section>
    ),
    languages:(col)=>(
      <section className="mb-6">
        <SectionBar name="languages" label={state.sectionNames.languages} col={col}/>
        <div className="title-divider"></div>
        {(state.languages||[]).map((l,i)=>(
          <div key={i} className="flex items-center justify-between min-w-0 mb-2" style={{fontFamily:metaFont}}>
            <span className="truncate">{l.name}</span>
            <div className="flex items-center gap-2">
              <div className="flex gap-0.5">
                {Array.from({length:5}).map((_,k)=><span key={k} className={`h-2 w-5 rounded ${k<l.score?'bg-neutral-800':'bg-neutral-300'}`}/>)}
              </div>
              <span className="text-xs text-neutral-600">{l.level}</span>
            </div>
            <div className="ml-2">
              <button className="chip" onClick={()=>moveItem('languages',i,'up')}>↑</button>
              <button className="chip" onClick={()=>moveItem('languages',i,'down')}>↓</button>
              <button className="chip danger" onClick={()=>setState(s=>({...s,languages:s.languages.filter((_,j)=>j!==i)}))}>×</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>setState(s=>({...s,languages:[...s.languages,{name:"",score:3,level:""}]}))}>+ Add language</button>
      </section>
    ),
    strengths:(col)=>(
      <section className="mb-6">
        <SectionBar name="strengths" label={state.sectionNames.strengths} col={col}/>
        <div className="title-divider"></div>
        {(state.strengths||[]).map((it,i)=>(
          <div key={it.id} className="flex items-center gap-2 mb-2" style={{fontFamily:bodyFont}}>
            {it.logo ? <div className="logo"><img src={it.logo} className="w-full h-full object-cover"/></div>
                     : (it.icon ? <span className="circle-icon" style={{color:accent}}><Icon name={it.icon} className="w-4 h-4"/></span> : null)}
            <span>{it.label}</span>
            <div className="ml-auto flex gap-1">
              <button className="chip" onClick={()=>moveItem('strengths',i,'up')}>↑</button>
              <button className="chip" onClick={()=>moveItem('strengths',i,'down')}>↓</button>
              <button className="chip danger" onClick={()=>setState(s=>({...s,strengths:s.strengths.filter(x=>x.id!==it.id)}))}>×</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>setState(s=>({...s,strengths:[...s.strengths,{id:rid(),icon:"bulb",label:""}]}))}>+ Add strength</button>
      </section>
    ),
    hobbies:(col)=>(
      <section className="mb-6">
        <SectionBar name="hobbies" label={state.sectionNames.hobbies} col={col}/>
        <div className="title-divider"></div>
        {(state.hobbies||[]).map((it,i)=>(
          <div key={it.id} className="flex items-center gap-2 mb-2" style={{fontFamily:bodyFont}}>
            {it.logo ? <div className="logo"><img src={it.logo} className="w-full h-full object-cover"/></div>
                     : (it.icon ? <span className="circle-icon" style={{color:accent}}><Icon name={it.icon} className="w-4 h-4"/></span> : null)}
            <span>{it.label}</span>
            <div className="ml-auto flex gap-1">
              <button className="chip" onClick={()=>moveItem('hobbies',i,'up')}>↑</button>
              <button className="chip" onClick={()=>moveItem('hobbies',i,'down')}>↓</button>
              <button className="chip danger" onClick={()=>setState(s=>({...s,hobbies:s.hobbies.filter(x=>x.id!==it.id)}))}>×</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>setState(s=>({...s,hobbies:[...s.hobbies,{id:rid(),icon:"camera",label:""}]}))}>+ Add hobby</button>
      </section>
    ),
    online:(col)=>(
      <section className="mb-6">
        <SectionBar name="online" label={state.sectionNames.online} col={col}/>
        <div className="title-divider"></div>
        <div className="text-sm flex flex-col gap-2" style={{fontFamily:metaFont}}>
          {state.online?.linkedin?.url && <a target="_blank" className="flex items-center gap-2 text-blue-700" href={state.online.linkedin.url}><span className="circle-icon" style={{color:accent}}><Icon name="linkedin" className="w-4 h-4"/></span>{state.online.linkedin.label||state.online.linkedin.url}</a>}
          {state.online?.github?.url && <a target="_blank" className="flex items-center gap-2 text-neutral-800" href={state.online.github.url}><span className="circle-icon" style={{color:accent}}><Icon name="github" className="w-4 h-4"/></span>{state.online.github.label||state.online.github.url}</a>}
          {state.online?.website?.url && <a target="_blank" className="flex items-center gap-2 text-blue-600" href={state.online.website.url}><span className="circle-icon" style={{color:accent}}><Icon name="globe" className="w-4 h-4"/></span>{state.online.website.label||state.online.website.url}</a>}
        </div>
      </section>
    ),
    laws:(col)=>(
      <section className="mb-6">
        <SectionBar name="laws" label={state.sectionNames.laws} col={col}/>
        <div className="title-divider"></div>
        <div className="text-xs text-neutral-500" style={{fontFamily:metaFont}}>{(state.laws||[]).join('\n')}</div>
      </section>
    ),
  };

  /* export exact A4 */
  function exportPDF(){
    const theme = {accent, fontSize, lineHeight, headingFont, bodyFont, metaFont, hWeight, subWeight};
    saveDoc({...state, _theme: theme}).then(()=>{
      document.documentElement.style.setProperty('--print-font-size',`${fontSize}pt`);
      document.body.classList.add('print-mode');
      window.print();
      setTimeout(()=>document.body.classList.remove('print-mode'),300);
    });
  }
  async function saveNow(){
    const theme = {accent, fontSize, lineHeight, headingFont, bodyFont, metaFont, hWeight, subWeight};
    await saveDoc({...state, _theme: theme});
    alert('Saved');
  }

  return (
    <div className="min-h-screen grid grid-cols-1 xl:grid-cols-[420px,1fr] gap-6">
      {/* TOP BAR */}
      <header id="toolbar" className="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-neutral-200">
        <div className="max-w-[1600px] mx-auto px-4 py-2 flex items-center gap-2">
          <a className="btn" href="./home.html">← Home</a>
          <div className="font-semibold tracking-tight">CV Studio</div>
          <span className="text-neutral-400">/</span>
          <div className="truncate">{docName}</div>
          <div className="ml-auto flex items-center gap-2">
            <button className="btn" onClick={saveNow}>Save</button>
            <button className="btn-primary" onClick={exportPDF}>Export PDF</button>
          </div>
        </div>

        <div className="max-w-[1600px] mx-auto px-4 pb-2 grid grid-cols-1 md:grid-cols-6 gap-2">
          <div className="flex items-center gap-2">
            <span className="mini">Template</span>
            <select className="input" onChange={e=>{
              const t=window.CV_TEMPLATES?.get(e.target.value)||window.CV_TEMPLATES?.get('default');
              const merged = t?.migrate ? t.migrate(state) : state;
              if (merged) setState(merged);
            }}>
              {(window.CV_TEMPLATES?.list?.() || [{id:'default',name:'Default'}]).map(t=><option key={t.id} value={t.id}>{t.name}</option>)}
            </select>
          </div>
          <div className="flex items-center gap-2">
            <span className="mini">Font preset</span>
            <select className="input" onChange={e=>{
              const p = FONT_PRESETS[parseInt(e.target.value)]||FONT_PRESETS[0];
              setHeadingFont(p.heading); setBodyFont(p.body); setMetaFont(p.meta); setHWeight(p.hWeight); setSubWeight(p.subWeight);
            }}>
              {FONT_PRESETS.map((p,i)=><option key={p.label} value={i}>{p.label}</option>)}
            </select>
          </div>
          <div className="flex items-center gap-2"><span className="mini">Size</span><input className="range" type="range" min="9" max="14" step="1" value={fontSize} onChange={e=>setFontSize(parseInt(e.target.value))}/></div>
          <div className="flex items-center gap-2"><span className="mini">Line</span><input className="range" type="range" min="1.2" max="1.8" step="0.05" value={lineHeight} onChange={e=>setLineHeight(parseFloat(e.target.value))}/></div>
          <div className="flex items-center gap-2"><span className="mini">Accent</span><input className="color-swatch" type="color" value={accent} onChange={e=>setAccent(e.target.value)}/></div>
          <div className="flex items-center gap-2"><span className="mini">Photo</span><button className="btn" onClick={()=>pickImage(url=>setState(s=>({...s,header:{...s.header,avatar:url}})))}>Upload</button></div>
        </div>
      </header>

      {/* LEFT: header editor */}
      <aside id="leftPane" className="px-4">
        <div className="sticky top-[110px]">
          <div className="sidebar-scroll">
            <div className="card p-4 mb-4">
              <div className="font-semibold mb-2">Header</div>
              <div className="grid grid-cols-2 gap-2">
                <input className="input" placeholder="Name" value={state.header.name} onChange={e=>setState(s=>({...s,header:{...s.header,name:e.target.value}}))}/>
                <input className="input" placeholder="Role" value={state.header.role} onChange={e=>setState(s=>({...s,header:{...s.header,role:e.target.value}}))}/>
                <input className="input" placeholder="Email" value={state.header.email} onChange={e=>setState(s=>({...s,header:{...s.header,email:e.target.value}}))}/>
                <input className="input" placeholder="Phone" value={state.header.phone} onChange={e=>setState(s=>({...s,header:{...s.header,phone:e.target.value}}))}/>
                <input className="input" placeholder="Residence" value={state.header.residence} onChange={e=>setState(s=>({...s,header:{...s.header,residence:e.target.value}}))}/>
                <input className="input" placeholder="Birthdate" value={state.header.birthdate} onChange={e=>setState(s=>({...s,header:{...s.header,birthdate:e.target.value}}))}/>
              </div>
              <label className="block text-sm mt-2">Summary</label>
              <textarea rows="3" className="input" value={state.summary} onChange={e=>setState(s=>({...s,summary:e.target.value}))}></textarea>
            </div>
          </div>
        </div>
      </aside>

      {/* RIGHT: A4 pages */}
      <section className="px-4">
        <div className="sticky top-[110px]">
          <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <div>
              {state._orders.left.map((sec,idx)=>(
                <div key={sec+'-'+idx} className="sheet card p-10 mx-auto mb-6" style={{width:"210mm",height:"297mm", lineHeight, fontFamily:bodyFont}}>
                  {idx===0 && (
                    <>
                      <div className="flex items-start gap-6 pb-4 border-b border-neutral-200">
                        <div className="flex-1 min-w-0">
                          <h1 className="text-3xl" style={{color:accent, fontFamily:headingFont, fontWeight:hWeight}}>{state.header.name}</h1>
                          <div className="text-lg" style={{color:"#0f172a", fontFamily:headingFont, fontWeight:subWeight}}>{state.header.role}</div>
                          <div className="text-sm text-neutral-800 mt-2" style={{fontFamily:metaFont}}>
                            {[state.header.email,state.header.phone,state.header.residence,state.header.birthdate].filter(Boolean).join(" • ")}
                          </div>
                        </div>
                        <div className="w-24 h-24 rounded-full bg-neutral-100 border overflow-hidden flex items-center justify-center">
                          {state.header.avatar ? <img src={state.header.avatar} className="w-full h-full object-cover" alt="avatar"/> : <span className="text-xs text-neutral-400">Photo</span>}
                        </div>
                      </div>
                      <p className="mt-4 text-neutral-800">{state.summary}</p>
                    </>
                  )}
                  {R[sec]?.('left')}
                </div>
              ))}
            </div>
            <div>
              {state._orders.right.map((sec,idx)=>(
                <div key={sec+'-'+idx} className="sheet card p-10 mx-auto mb-6" style={{width:"210mm",height:"297mm", lineHeight, fontFamily:bodyFont}}>
                  {R[sec]?.('right')}
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>
    </div>
  );
}

/* --- mount after DOM is ready --- */
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  }catch(e){
    console.error('Editor bootstrap failed:', e);
    const r=document.getElementById('root'); if(r) r.innerHTML='<div style="padding:16px;color:#b91c1c;">Editor failed to load. Check the console for details.</div>';
  }
});
</script>
</body>
</html>