<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CV Studio — Editor</title>

<style>
  :root{
    --accent:#2b8bd8;
    --rule:#e5e7eb;
    --bg:#f6f7fb;
    --sheet-w:210mm;
    --sheet-h:297mm;
    --pad:18mm 16mm;
    --rail-w:240px;
    --topbar-h:56px;
  }
  *{box-sizing:border-box}
  html,body,#root{height:100%}
  body{margin:0;background:var(--bg);color:#111827;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}

  /* Top bar */
  .topbar{
    height:var(--topbar-h);display:flex;align-items:center;gap:8px;padding:10px 14px;
    border-bottom:1px solid var(--rule);background:#fffffff2;backdrop-filter:saturate(120%) blur(6px);position:sticky;top:0;z-index:40
  }
  .btn{border:1px solid var(--rule);background:#fff;border-radius:8px;padding:6px 10px;font-size:14px;cursor:pointer}
  .btn:hover{background:#f3f4f6}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn-primary:hover{filter:brightness(.96)}
  .btn-danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .field{border:1px solid var(--rule);border-radius:8px;padding:6px 8px;font-size:14px;background:#fff}

  /* Main split */
  .main{display:grid;grid-template-columns:var(--rail-w) 1fr;height:calc(100% - var(--topbar-h))}
  .rail{
    background:#fff;border-right:1px solid var(--rule);padding:10px 8px;overflow:auto
  }
  .rail-group{margin:8px 0 14px}
  .rail-title{font-size:12px;color:#6b7280;margin:0 8px 6px}
  .rail-item{
    display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;margin:6px 0;border:1px solid var(--rule);
    background:#fff;border-radius:10px;cursor:pointer;font-weight:500
  }
  .rail-item:hover{background:#f6f7fb}
  .rail-item .k{width:26px;height:26px;border-radius:8px;display:grid;place-items:center;background:#eef6ff;color:#1e40af;font-weight:700}

  /* Canvas area */
  .canvas{overflow:auto;padding:24px;display:flex;justify-content:center;align-items:flex-start}
  .stack{display:flex;flex-direction:column;gap:24px;align-items:center;width:100%}

  /* Sheet + rows */
  .sheet{width:var(--sheet-w);min-height:var(--sheet-h);background:#fff;box-shadow:0 12px 36px rgba(0,0,0,.08);padding:var(--pad)}
  .row{display:grid;gap:18px;position:relative;margin-bottom:14px}
  .single{grid-template-columns:1fr}
  .r-13-23{grid-template-columns:1fr 2fr}
  .r-23-13{grid-template-columns:2fr 1fr}

  /* Row tools (floating) */
  .row-tools{position:absolute;left:-12px;top:-12px;display:flex;gap:6px;z-index:2}
  .chip{border:1px solid var(--rule);background:#fff;border-radius:999px;padding:4px 8px;font-size:12px;cursor:pointer}
  .chip:hover{background:#f3f4f6}

  /* Column tools + pills */
  .col-tools{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px}
  .pill{border:1px dashed var(--rule);background:#fafafa;border-radius:999px;padding:2px 8px;font-size:11px}
  .pill .x{border:none;background:none;margin-left:6px;color:#6b7280;cursor:pointer}
  .pill .x:hover{color:#111827}

  /* Section styling */
  .title{margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid var(--rule);
         text-transform:uppercase;letter-spacing:.08em;font-size:11px;font-weight:650;color:var(--accent)}
  .meta{color:#6b7280}
  .editable[contenteditable="true"]{outline:0}
  .editable[contenteditable="true"]:focus{box-shadow:inset 0 0 0 2px rgba(43,139,216,.25);border-radius:4px}

  @media print{
    .topbar,.rail{display:none!important}
    body{background:#fff!important}
    .canvas{padding:0!important}
    .sheet{box-shadow:none!important;break-after:page}
    @page{size:A4;margin:14mm}
  }
</style>
</head>
<body>
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel" data-presets="env,react">
const {useState,useEffect} = React;
const rid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
const param=(k,d=null)=>{try{return new URL(location.href).searchParams.get(k)??d}catch{return d}};
const uid=param('uid',null), docName=param('doc','Default');
const clone=o=>JSON.parse(JSON.stringify(o??{}));
const Store={
  async load(name){ try{return JSON.parse(localStorage.getItem("cvdoc:"+name)||"null")}catch{return null} },
  async save(name,data){ localStorage.setItem("cvdoc:"+name, JSON.stringify(data)); }
};

/* ALWAYS normalize */
function migrate(raw){
  const d=clone(raw);
  d.header=d.header||{name:"JOHN DOE",role:"Senior Software Architect",email:"",phone:"",city:"",birth:"",avatar:""};
  d.summary=(typeof d.summary==="string")?d.summary:"Breve riepilogo professionale.";
  d.sectionNames=d.sectionNames||{
    headerSummary:"Profilo Professionale", experience:"Esperienza", education:"Formazione",
    volunteering:"Volontariato", projects:"Progetti", certifications:"Certificazioni",
    awards:"Premi", skills:"Competenze", languages:"Lingue", strengths:"Punti di forza",
    hobbies:"Hobby", online:"Online", laws:"Laws"
  };
  const arrs=["experience","education","volunteering","projects","certifications","awards","skills","languages","strengths","hobbies"];
  arrs.forEach(k=>{ if(!Array.isArray(d[k])) d[k]=[]; });
  d.online=d.online||{};
  d.laws=Array.isArray(d.laws)?d.laws:[d.laws||"Autorizzo il trattamento dei dati personali ai sensi del GDPR 2016/679."];
  d._theme=d._theme||{accent:"#2b8bd8",fontSize:11,lineHeight:1.45};
  d._theme.accent=d._theme.accent||"#2b8bd8";
  d._theme.fontSize=d._theme.fontSize||11;
  d._theme.lineHeight=d._theme.lineHeight||1.45;
  if(!Array.isArray(d._layout)||d._layout.length===0){
    d._layout=[{id:rid(),page:1,rows:[
      {id:rid(),type:"single",left:["headerSummary"],right:[]},
      {id:rid(),type:"r-23-13",left:["experience"],right:["skills","languages","online","laws"]}
    ]}];
  }else{
    d._layout=d._layout.map((pg,i)=>({
      id:pg?.id||rid(),
      page:typeof pg?.page==="number"?pg.page:(i+1),
      rows:Array.isArray(pg?.rows)?pg.rows.map(r=>({
        id:r?.id||rid(),
        type:(["single","r-13-23","r-23-13","13-23","23-13"].includes(r?.type)
              ? (r.type==="13-23"?"r-13-23":r.type==="23-13"?"r-23-13":r.type)
              :"single"),
        left:Array.isArray(r?.left)?r.left.filter(Boolean):[],
        right:Array.isArray(r?.right)?r.right.filter(Boolean):[]
      })):[{id:rid(),type:"single",left:[],right:[]}]
    }));
  }
  return d;
}

/* Safe initial seed so first paint never crashes */
const SAFE_DOC=migrate({
  experience:[
    {id:rid(), title:"Senior Software Architect", company:"Google", period:"2018 – 2022", location:"San Diego, CA",
     bullets:["Designed and deployed 2 cloud data architectures.","Communicated with CTO monthly on business initiatives."]}
  ],
  skills:[{id:rid(), group:"Technical", items:["Java","API","Cloud","Design Patterns","Critical Thinking"]}],
  languages:[{id:rid(), name:"Italiano", level:"Madrelingua"}]
});

/* Small contentEditable primitive */
const CE=({value,onChange,placeholder="",style})=>(
  <div className="editable"
       contentEditable suppressContentEditableWarning
       onBlur={e=>onChange(e.currentTarget.textContent||"")}
       onKeyDown={e=>{if(e.key==="Enter"){e.preventDefault();e.currentTarget.blur();}}}
       style={style||{}}>{value||placeholder}</div>
);

function App(){
  const [doc,setDoc]=useState(SAFE_DOC);
  const [reorder,setReorder]=useState(false); // reorder mode (like your screenshot)

  useEffect(()=>{(async()=>{
    const saved=await Store.load(docName);
    setDoc(migrate(saved||{}));
  })()},[]);

  useEffect(()=>{document.documentElement.style.setProperty('--accent',doc._theme?.accent||'#2b8bd8')},[doc._theme?.accent]);

  const save=async()=>{await Store.save(docName,doc); alert("Salvato");};
  const exportPDF=async()=>{await Store.save(docName,doc); requestAnimationFrame(()=>window.print());};

  /* Page ops */
  const addPage=()=>setDoc(p=>{const d=migrate(p); const last=d._layout[d._layout.length-1]; d._layout.push({id:rid(),page:(last?.page||0)+1,rows:[{id:rid(),type:"single",left:["headerSummary"],right:[]} ]});return d;});
  const delLast=()=>setDoc(p=>{const d=migrate(p); if(d._layout.length>1) d._layout.pop(); return d;});

  /* Row ops */
  const changeRowType=(pi,ri,t)=>setDoc(p=>{const d=migrate(p); d._layout[pi].rows[ri].type=t; return d;});
  const addRowBelow=(pi,ri)=>setDoc(p=>{const d=migrate(p);const r=d._layout[pi].rows[ri];d._layout[pi].rows.splice(ri+1,0,{id:rid(),type:r.type,left:[],right:[]});return d;});
  const delRow=(pi,ri)=>setDoc(p=>{const d=migrate(p); if(d._layout[pi].rows.length>1) d._layout[pi].rows.splice(ri,1); return d;});

  /* Section ops on row/col */
  const ALL_SECS=["headerSummary","experience","education","volunteering","projects","certifications","awards","skills","languages","strengths","hobbies","online","laws"];
  const addSec=(pi,ri,side,k)=>setDoc(p=>{const d=migrate(p); (side==="left"?d._layout[pi].rows[ri].left:d._layout[pi].rows[ri].right).push(k); return d;});
  const rmSec=(pi,ri,side,i)=>setDoc(p=>{const d=migrate(p); (side==="left"?d._layout[pi].rows[ri].left:d._layout[pi].rows[ri].right).splice(i,1); return d;});
  const mvSec=(pi,ri,side,i,dir)=>setDoc(p=>{const d=migrate(p); const a=side==="left"?d._layout[pi].rows[ri].left:d._layout[pi].rows[ri].right; const j=dir==="up"?i-1:i+1; if(j<0||j>=a.length) return p; [a[i],a[j]]=[a[j],a[i]]; return d;});
  const swapSec=(pi,ri,side,i)=>setDoc(p=>{const d=migrate(p); const row=d._layout[pi].rows[ri]; const from=side==="left"?row.left:row.right; const to=side==="left"?row.right:row.left; to.push(from.splice(i,1)[0]); return d;});

  /* Logos/photos */
  const pickImage=(cb)=>{const x=document.createElement('input'); x.type='file'; x.accept='image/*'; x.onchange=e=>{const f=e.target.files?.[0]; if(!f)return; const r=new FileReader(); r.onload=()=>cb(String(r.result)); r.readAsDataURL(f)}; x.click();};
  const setLogo=(key,i,url)=>setDoc(p=>{const d=migrate(p); (d[key]||[])[i].logo=url; return d;});

  /* Section title inline (editable on sheet) */
  const Title=({keyName})=><div className="title"><CE value={doc.sectionNames[keyName]} onChange={v=>setDoc(p=>{const d=migrate(p); d.sectionNames[keyName]=v; return d;})}/></div>;

  /* Renderers */
  const R={
    headerSummary:()=>(<section style={{borderBottom:"1px solid var(--rule)",paddingBottom:"8px"}}>
      <CE value={doc.header.name} onChange={v=>setDoc(p=>{const d=migrate(p); d.header.name=v; return d;})} style={{fontSize:"22pt",fontWeight:700,color:"var(--accent)"}}/>
      <CE value={doc.header.role} onChange={v=>setDoc(p=>{const d=migrate(p); d.header.role=v; return d;})} style={{fontSize:"12pt",fontWeight:500,color:"#374151"}}/>
      <div className="meta" style={{marginTop:"6px"}}>
        <CE value={[doc.header.email,doc.header.phone,doc.header.city,doc.header.birth].filter(Boolean).join(" • ")}
            onChange={v=>setDoc(p=>{const d=migrate(p); d.header.meta=v; return d;})}/>
      </div>
      <CE value={doc.summary} onChange={v=>setDoc(p=>{const d=migrate(p); d.summary=v; return d;})} style={{marginTop:"8px",fontSize:"10pt"}}/>
      <div style={{display:"flex",gap:"6px",marginTop:"6px"}}>
        <button className="chip" onClick={()=>pickImage(url=>setDoc(p=>{const d=migrate(p); d.header.avatar=url; return d;}))}>Foto</button>
        {doc.header.avatar && <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.header.avatar=""; return d;})}>Rimuovi foto</button>}
      </div>
    </section>),

    experience:()=>(<section>
      <Title keyName="experience"/>
      {(doc.experience||[]).map((ex,i)=>(
        <div key={ex.id||i} style={{marginBottom:"8px"}}>
          <div style={{display:"flex",justifyContent:"space-between",gap:"12px"}}>
            <CE value={ex.title} onChange={v=>setDoc(p=>{const d=migrate(p); d.experience[i].title=v; return d;})} style={{fontWeight:600}}/>
            <div className="meta"><CE value={ex.period} onChange={v=>setDoc(p=>{const d=migrate(p); d.experience[i].period=v; return d;})}/></div>
          </div>
          <div><span style={{color:"var(--accent)"}}><CE value={ex.company} onChange={v=>setDoc(p=>{const d=migrate(p); d.experience[i].company=v; return d;})}/></span></div>
          <div className="meta"><CE value={ex.location} onChange={v=>setDoc(p=>{const d=migrate(p); d.experience[i].location=v; return d;})}/></div>
          {(ex.bullets||[]).length>0 &&
            <ul style={{margin:"6px 0 0 18px"}}>
              {ex.bullets.map((b,j)=><li key={j}><CE value={b} onChange={v=>setDoc(p=>{const d=migrate(p); d.experience[i].bullets[j]=v; return d;})}/></li>)}
            </ul>}
          <div style={{display:"flex",gap:"6px",flexWrap:"wrap",marginTop:"6px"}}>
            <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.experience[i].bullets=[...(d.experience[i].bullets||[]),""]; return d;})}>+ Bullet</button>
            <button className="chip" onClick={()=>pickImage(u=>setLogo('experience',i,u))}>Logo</button>
            {ex.logo && <button className="chip" onClick={()=>setLogo('experience',i,"")}>Rimuovi logo</button>}
            <button className="chip btn-danger" onClick={()=>setDoc(p=>{const d=migrate(p); d.experience.splice(i,1); return d;})}>Elimina</button>
          </div>
        </div>
      ))}
      <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.experience.push({id:rid(),title:"",company:"",period:"",location:"",logo:"",bullets:[]}); return d;})}>+ Esperienza</button>
    </section>),

    education:()=>(<section>
      <Title keyName="education"/>
      {(doc.education||[]).map((ed,i)=>(
        <div key={i} style={{marginBottom:"8px"}}>
          <div style={{display:"flex",justifyContent:"space-between",gap:"12px"}}>
            <CE value={ed.degree} onChange={v=>setDoc(p=>{const d=migrate(p); d.education[i].degree=v; return d;})} style={{fontWeight:600}}/>
            <div className="meta">
              <CE value={ed.period} onChange={v=>setDoc(p=>{const d=migrate(p); d.education[i].period=v; return d;})}/>
              {"  |  GPA "}<CE value={ed.gpa||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.education[i].gpa=v; return d;})}/>
            </div>
          </div>
          <div><span style={{color:"var(--accent)"}}><CE value={ed.school} onChange={v=>setDoc(p=>{const d=migrate(p); d.education[i].school=v; return d;})}/></span></div>
          <div className="meta"><CE value={ed.location} onChange={v=>setDoc(p=>{const d=migrate(p); d.education[i].location=v; return d;})}/></div>
          <div style={{marginTop:"6px"}}><button className="chip btn-danger" onClick={()=>setDoc(p=>{const d=migrate(p); d.education.splice(i,1); return d;})}>Elimina</button></div>
        </div>
      ))}
      <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.education.push({degree:"",school:"",period:"",location:"",gpa:""}); return d;})}>+ Formazione</button>
    </section>),

    projects:()=>(<section>
      <Title keyName="projects"/>
      {(doc.projects||[]).map((pr,i)=>(
        <div key={i} style={{marginBottom:"8px"}}>
          <div style={{display:"flex",justifyContent:"space-between",gap:"12px"}}>
            <CE value={pr.name} onChange={v=>setDoc(p=>{const d=migrate(p); d.projects[i].name=v; return d;})} style={{fontWeight:600}}/>
            <div className="meta"><CE value={pr.period} onChange={v=>setDoc(p=>{const d=migrate(p); d.projects[i].period=v; return d;})}/></div>
          </div>
          <div className="meta"><CE value={pr.location} onChange={v=>setDoc(p=>{const d=migrate(p); d.projects[i].location=v; return d;})}/></div>
          <div style={{color:"var(--accent)",fontWeight:600}}><CE value={pr.domain||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.projects[i].domain=v; return d;})}/></div>
          {(pr.bullets||[]).length>0 && <ul style={{margin:"6px 0 0 18px"}}>{pr.bullets.map((b,j)=><li key={j}><CE value={b} onChange={v=>setDoc(p=>{const d=migrate(p); d.projects[i].bullets[j]=v; return d;})}/></li>)}</ul>}
          <div style={{marginTop:"6px",display:"flex",gap:"6px"}}>
            <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.projects[i].bullets=[...(d.projects[i].bullets||[]),""]; return d;})}>+ Bullet</button>
            <button className="chip btn-danger" onClick={()=>setDoc(p=>{const d=migrate(p); d.projects.splice(i,1); return d;})}>Elimina</button>
          </div>
        </div>
      ))}
      <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.projects.push({name:"",domain:"",period:"",location:"",bullets:[]}); return d;})}>+ Progetto</button>
    </section>),

    certifications:()=>(<section>
      <Title keyName="certifications"/>
      {(doc.certifications||[]).map((c,i)=>(
        <div key={i} style={{marginBottom:"8px",display:"flex",gap:"10px",alignItems:"flex-start"}}>
          {c.logo && <img src={c.logo} style={{width:"28px",height:"28px",borderRadius:"6px",border:"1px solid var(--rule)",objectFit:"cover"}}/>}
          <div style={{flex:"1 1 auto"}}>
            <div style={{color:"var(--accent)"}}><CE value={c.line1||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.certifications[i].line1=v; return d;})}/></div>
            <div><CE value={c.line2||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.certifications[i].line2=v; return d;})}/></div>
            <div style={{display:"flex",gap:"6px",marginTop:"6px"}}>
              <button className="chip" onClick={()=>pickImage(u=>setLogo('certifications',i,u))}>Logo</button>
              {c.logo && <button className="chip" onClick={()=>setLogo('certifications',i,"")}>Rimuovi</button>}
              <button className="chip btn-danger" onClick={()=>setDoc(p=>{const d=migrate(p); d.certifications.splice(i,1); return d;})}>Elimina</button>
            </div>
          </div>
        </div>
      ))}
      <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.certifications.push({line1:"",line2:"",logo:""}); return d;})}>+ Certificazione</button>
    </section>),

    awards:()=>(<section>
      <Title keyName="awards"/>
      {(doc.awards||[]).map((a,i)=>(
        <div key={i} style={{marginBottom:"8px",display:"flex",gap:"10px",alignItems:"flex-start"}}>
          {a.logo && <img src={a.logo} style={{width:"28px",height:"28px",borderRadius:"6px",border:"1px solid var(--rule)",objectFit:"cover"}}/>}
          <div style={{flex:"1 1 auto"}}>
            <div style={{fontWeight:600}}><CE value={a.line1||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.awards[i].line1=v; return d;})}/></div>
            <div><CE value={a.line2||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.awards[i].line2=v; return d;})}/></div>
            <div style={{display:"flex",gap:"6px",marginTop:"6px"}}>
              <button className="chip" onClick={()=>pickImage(u=>setLogo('awards',i,u))}>Logo</button>
              {a.logo && <button className="chip" onClick={()=>setLogo('awards',i,"")}>Rimuovi</button>}
              <button className="chip btn-danger" onClick={()=>setDoc(p=>{const d=migrate(p); d.awards.splice(i,1); return d;})}>Elimina</button>
            </div>
          </div>
        </div>
      ))}
      <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.awards.push({line1:"",line2:"",logo:""}); return d;})}>+ Premio</button>
    </section>),

    skills:()=>(<section>
      <Title keyName="skills"/>
      {(doc.skills||[]).map((g,gi)=>(
        <div key={g.id||gi} style={{marginBottom:"8px"}}>
          <div style={{fontWeight:500}}><CE value={g.group||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.skills[gi].group=v; return d;})}/></div>
          <div style={{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"4px"}}>
            {(g.items||[]).map((t,ti)=>
              <span key={ti} style={{border:"1px solid var(--rule)",borderRadius:"999px",padding:"2px 8px",fontSize:"11px"}}>
                <CE value={t} onChange={v=>setDoc(p=>{const d=migrate(p); d.skills[gi].items[ti]=v; return d;})}/>
              </span>
            )}
          </div>
          <div style={{display:"flex",gap:"6px",marginTop:"6px"}}>
            <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.skills[gi].items=[...(d.skills[gi].items||[]),""]; return d;})}>+ Skill</button>
            <button className="chip btn-danger" onClick={()=>setDoc(p=>{const d=migrate(p); d.skills.splice(gi,1); return d;})}>Elimina gruppo</button>
          </div>
        </div>
      ))}
      <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.skills.push({id:rid(),group:"",items:[]}); return d;})}>+ Gruppo</button>
    </section>),

    languages:()=>(<section>
      <Title keyName="languages"/>
      {(doc.languages||[]).map((l,li)=>(
        <div key={l.id||li} style={{display:"flex",justifyContent:"space-between",marginBottom:"6px"}}>
          <CE value={l.name||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.languages[li].name=v; return d;})}/>
          <div className="meta"><CE value={l.level||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.languages[li].level=v; return d;})}/></div>
        </div>
      ))}
      <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.languages.push({id:rid(),name:"",level:""}); return d;})}>+ Lingua</button>
    </section>),

    strengths:()=>(<section>
      <Title keyName="strengths"/>
      {(doc.strengths||[]).map((st,i)=>(
        <div key={st.id||i} style={{display:"flex",gap:"8px",alignItems:"center",marginBottom:"6px"}}>
          {st.logo && <img src={st.logo} style={{width:"28px",height:"28px",borderRadius:"6px",border:"1px solid var(--rule)",objectFit:"cover"}}/>}
          <CE value={st.label||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.strengths[i].label=v; return d;})}/>
          <div style={{marginLeft:"auto",display:"flex",gap:"6px"}}>
            <button className="chip" onClick={()=>pickImage(u=>setLogo('strengths',i,u))}>Logo</button>
            {st.logo && <button className="chip" onClick={()=>setLogo('strengths',i,"")}>Rimuovi</button>}
            <button className="chip btn-danger" onClick={()=>setDoc(p=>{const d=migrate(p); d.strengths.splice(i,1); return d;})}>Elimina</button>
          </div>
        </div>
      ))}
      <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.strengths.push({id:rid(),label:""}); return d;})}>+ Punto di forza</button>
    </section>),

    hobbies:()=>(<section>
      <Title keyName="hobbies"/>
      {(doc.hobbies||[]).map((hb,i)=>(
        <div key={hb.id||i} style={{display:"flex",gap:"8px",alignItems:"center",marginBottom:"6px"}}>
          {hb.logo && <img src={hb.logo} style={{width:"28px",height:"28px",borderRadius:"6px",border:"1px solid var(--rule)",objectFit:"cover"}}/>}
          <CE value={hb.label||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.hobbies[i].label=v; return d;})}/>
          <div style={{marginLeft:"auto",display:"flex",gap:"6px"}}>
            <button className="chip" onClick={()=>pickImage(u=>setLogo('hobbies',i,u))}>Logo</button>
            {hb.logo && <button className="chip" onClick={()=>setLogo('hobbies',i,"")}>Rimuovi</button>}
            <button className="chip btn-danger" onClick={()=>setDoc(p=>{const d=migrate(p); d.hobbies.splice(i,1); return d;})}>Elimina</button>
          </div>
        </div>
      ))}
      <button className="chip" onClick={()=>setDoc(p=>{const d=migrate(p); d.hobbies.push({id:rid(),label:""}); return d;})}>+ Hobby</button>
    </section>),

    online:()=>(<section>
      <Title keyName="online"/>
      <div className="meta"><CE value={doc.online?.linkedin?.label||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.online.linkedin=d.online.linkedin||{}; d.online.linkedin.label=v; return d;})}/></div>
      <div className="meta"><CE value={doc.online?.github?.label||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.online.github=d.online.github||{}; d.online.github.label=v; return d;})}/></div>
      <div className="meta"><CE value={doc.online?.website?.label||""} onChange={v=>setDoc(p=>{const d=migrate(p); d.online.website=d.online.website||{}; d.online.website.label=v; return d;})}/></div>
    </section>),

    laws:()=>(<section>
      <Title keyName="laws"/>
      <div className="meta"><CE value={(doc.laws||[]).join("\n")} onChange={v=>setDoc(p=>{const d=migrate(p); d.laws=[v]; return d;})}/></div>
    </section>)
  };

  const Row=({pi,ri,row})=>{
    const cls=row.type==="single"?"row single":row.type==="r-13-23"?"row r-13-23":"row r-23-13";
    return (
      <div className={cls} style={{fontSize:(doc._theme||{}).fontSize+"pt",lineHeight:(doc._theme||{}).lineHeight}}>
        {/* floating row tools */}
        <div className="row-tools" style={{display:reorder?"flex":"none"}}>
          <select className="field" value={row.type} onChange={e=>changeRowType(pi,ri,e.target.value)}>
            <option value="single">Singola</option>
            <option value="r-13-23">1/3 – 2/3</option>
            <option value="r-23-13">2/3 – 1/3</option>
          </select>
          <button className="btn" onClick={()=>addRowBelow(pi,ri)}>+ riga</button>
          <button className="btn-danger" onClick={()=>delRow(pi,ri)}>Elimina riga</button>
        </div>

        {/* LEFT column */}
        <div>
          {reorder && <ColTools pi={pi} ri={ri} side="left" row={row}/>}
          {(row.left||[]).map((k,idx)=><div key={k+idx}>{R[k]?R[k]():<div className="meta">Unknown: {k}</div>}</div>)}
        </div>
        {/* RIGHT column */}
        {row.type!=="single" && (
          <div>
            {reorder && <ColTools pi={pi} ri={ri} side="right" row={row}/>}
            {(row.right||[]).map((k,idx)=><div key={k+idx}>{R[k]?R[k]():<div className="meta">Unknown: {k}</div>}</div>)}
          </div>
        )}
      </div>
    );
  };

  const ColTools=({pi,ri,side,row})=>{
    const items = side==="left"? (row.left||[]) : (row.right||[]);
    return (
      <div className="col-tools">
        {items.map((sec,i)=>(
          <span key={sec+i} className="pill">
            {doc.sectionNames[sec]||sec}
            <button className="x" title="su" onClick={()=>mvSec(pi,ri,side,i,"up")}>↑</button>
            <button className="x" title="giù" onClick={()=>mvSec(pi,ri,side,i,"down")}>↓</button>
            {row.type!=="single" && <button className="x" title="scambia colonna" onClick={()=>swapSec(pi,ri,side,i)}>⇆</button>}
            <button className="x" title="rimuovi" onClick={()=>rmSec(pi,ri,side,i)}>✕</button>
          </span>
        ))}
        <select className="field" onChange={e=>{ if(!e.target.value) return; addSec(pi,ri,side,e.target.value); e.target.value=""; }}>
          <option value="">+ sezione…</option>
          {ALL_SECS.map(k=><option key={k} value={k}>{doc.sectionNames[k]||k}</option>)}
        </select>
      </div>
    );
  };

  return (
    <div style={{height:"100%",display:"flex",flexDirection:"column"}}>
      <div className="topbar">
        <a className="btn" href="./home.html">← Home</a>
        <button className="btn" onClick={()=>setReorder(v=>!v)}>{reorder?"Esci riordina":"Riordina"}</button>
        <button className="btn" onClick={addPage}>+ Pagina</button>
        <button className="btn-danger" onClick={delLast}>− Ultima</button>
        <button className="btn" onClick={save}>Salva</button>
        <button className="btn-primary" onClick={exportPDF}>Esporta PDF</button>
        <span style={{marginLeft:"auto",fontWeight:700}}>CV Studio</span>
      </div>

      <div className="main">
        <!-- Left rail like the screenshot -->
        <div className="rail">
          <div className="rail-group">
            <div className="rail-title">Azioni</div>
            <div className="rail-item" onclick="void(0)"><span class="k">+</span> Aggiungi sezione (usa menu in pagina)</div>
            <div className="rail-item" onclick="void(0)"><span class="k">↕︎</span> Riordina (toggle sopra)</div>
            <div className="rail-item" onclick="void(0)"><span class="k">⌘F</span> Modelli & Font (WIP)</div>
            <div className="rail-item" onclick="void(0)"><span class="k">✓</span> Controlla (manuale)</div>
            <div className="rail-item" onclick="void(0)"><span class="k">↓</span> Scarica (usa “Esporta PDF”)</div>
          </div>

          <div className="rail-group">
            <div className="rail-title">Tema</div>
            <div style="display:grid;grid-template-columns:90px 1fr;gap:8px;align-items:center;margin:6px 0">
              <div class="meta">Accent</div>
              <input type="color" class="field" value="" id="accentPick"/>
            </div>
            <div style="display:grid;grid-template-columns:90px 1fr;gap:8px;align-items:center;margin:6px 0">
              <div class="meta">T. base</div>
              <input type="range" min="9" max="14" step="1" id="fsRange"/>
            </div>
            <div style="display:grid;grid-template-columns:90px 1fr;gap:8px;align-items:center;margin:6px 0">
              <div class="meta">Interlinea</div>
              <input type="range" min="1.2" max="1.8" step="0.05" id="lhRange"/>
            </div>
          </div>

          <div className="rail-group">
            <div className="rail-title">Etichette sezione</div>
            <div id="labelsBox"></div>
          </div>
        </div>

        
        <div className="canvas">
          <div className="stack">
            {(doc._layout||[]).sort((a,b)=>a.page-b.page).map((pg,pi)=>(
              <div key={pg.id||pi} className="sheet">
                {(pg.rows||[]).map((row,ri)=><Row key={row.id||ri} pi={pi} ri={ri} row={row}/>)}
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );

  /* wire simple inputs in the rail */
}
const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);

/* Imperative wiring for theme sliders & labels (keeps React code readable) */
(function wire(){
  const accent=document.getElementById('accentPick');
  const fs=document.getElementById('fsRange');
  const lh=document.getElementById('lhRange');
  const labelsBox=document.getElementById('labelsBox');

  function getDoc(){ try{return JSON.parse(localStorage.getItem("cvdoc:"+ (new URL(location.href).searchParams.get('doc')||'Default'))||"null")}catch{return null} }
  function putDoc(d){ localStorage.setItem("cvdoc:"+ (new URL(location.href).searchParams.get('doc')||'Default'), JSON.stringify(d)); }

  function refreshControls(){
    const d = (getDoc()||{}); const m = (d._theme||{});
    accent && (accent.value = m.accent || '#2b8bd8');
    fs && (fs.value = (m.fontSize||11));
    lh && (lh.value = (m.lineHeight||1.45));
    labelsBox.innerHTML = "";
    const names = d.sectionNames || {};
    Object.keys(names).forEach(k=>{
      const wrap=document.createElement('div');
      wrap.style.display='grid'; wrap.style.gridTemplateColumns='90px 1fr'; wrap.style.gap='8px'; wrap.style.alignItems='center'; wrap.style.margin='6px 0';
      const left=document.createElement('div'); left.className='meta'; left.textContent=k;
      const inp=document.createElement('input'); inp.className='field'; inp.value=names[k];
      inp.oninput=()=>{ const doc=getDoc()||{}; doc.sectionNames=doc.sectionNames||{}; doc.sectionNames[k]=inp.value; putDoc(doc); location.reload(); };
      wrap.appendChild(left); wrap.appendChild(inp); labelsBox.appendChild(wrap);
    });
  }
  refreshControls();

  function updateTheme(key, val){
    const d=getDoc()||{}; d._theme=d._theme||{}; d._theme[key]=val; putDoc(d); location.reload();
  }
  accent && (accent.oninput = e=>updateTheme('accent', e.target.value));
  fs && (fs.oninput = e=>updateTheme('fontSize', Number(e.target.value)));
  lh && (lh.oninput = e=>updateTheme('lineHeight', Number(e.target.value)));
})();
</script>
</body>
</html>