<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CV Studio — Editor</title>

<link rel="stylesheet" href="./styles.css"/>
<link rel="stylesheet" href="./fonts/fonts.css"/>

<!-- Minimal safety styles -->
<style>
  :root {
    --rule:#d1d5db;      /* thin gray line */
    --sheet-w: 210mm;    /* A4 width */
    --sheet-h: 297mm;    /* A4 height */
  }

  /* Basic tokens */
  .icon{ display:inline-block; width:1em; height:1em; background:currentColor; }
  .circle-icon{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:9999px; background:#e5e7eb; color:var(--accent,#2563eb); }
  .logo{ width:32px; height:32px; border-radius:9999px; overflow:hidden; border:1px solid #e5e7eb; flex:0 0 auto; }
  .btn{ padding:.4rem .7rem; border:1px solid #e5e7eb; border-radius:.5rem; background:white; }
  .btn-primary{ padding:.45rem .8rem; border-radius:.5rem; background:#111827; color:white; }
  .btn-danger{ padding:.4rem .7rem; border:1px solid #fecaca; background:#fee2e2; color:#991b1b; border-radius:.5rem; }
  .chip{ padding:.15rem .45rem; border:1px solid #e5e7eb; border-radius:.4rem; background:white; font-size:.8rem; }
  .input{ border:1px solid #e5e7eb; border-radius:.4rem; padding:.35rem .5rem; background:white; }
  .range{ width:140px; }
  .color-swatch{ width:36px; height:28px; padding:0; border:1px solid #e5e7eb; border-radius:.4rem; }
  .card{ background:white; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .title-divider{ height:1px; background:var(--rule); margin:.25rem 0 .5rem; }
  .meta{ color:#6b7280; }
  .tag{ padding:.15rem .45rem; border:1px solid #e5e7eb; border-radius:999px; font-size:.8rem; }
  .editable{ outline: none; }
  .editable[contenteditable="true"]:focus{ box-shadow: inset 0 0 0 2px rgba(37,99,235,.25); border-radius: .25rem; }

  /* A4 sheets */
  .sheet{ width:var(--sheet-w); min-height:var(--sheet-h); box-shadow:0 10px 25px rgba(0,0,0,.06); background:white; }
  .sheet .grid-band{ display:grid; gap:24px; }
  .band-single{ grid-template-columns: 1fr; }
  .band-13-23{ grid-template-columns: 1fr 2fr; }
  .band-23-13{ grid-template-columns: 2fr 1fr; }

  .sidebar-scroll{ max-height: calc(100vh - 140px); overflow:auto; padding-bottom: 24px; }

  @media print{
    body.print-mode .sheet{ break-after: page; box-shadow:none !important; }
    #toolbar, #leftPane { display:none!important; }
    body{ background:white!important; }
    @page{ size: A4; margin: 14mm; }
  }
</style>

<!-- UI libs -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase SDKs (ok even if not configured yet) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Storage/Auth -->
<script src="./auth.firebase.js"></script>
<script src="./storage.firebase.js"></script>
<script src="./storage.local.js"></script>

<!-- Templates (must exist) -->
<script src="./templates/default.js?v=20251019"></script>
<script src="./templates/minimal.js?v=20251019"></script>
</head>
<body class="bg-neutral-100">
<div id="root"></div>

<script type="text/babel">
/* =========================
   Utilities + setup
   ========================= */
const {useState,useEffect,useCallback,useRef} = React;

const rid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const param = (k, d=null)=> { try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{return d;} };
const uid  = param('uid', null);
const docName = param('doc','Default');

/* Deep clone small structures */
const deepClone = (o)=> JSON.parse(JSON.stringify(o||{}));

/* Icons via CSS mask, color follows currentColor (we set currentColor from section accent) */
function Icon({name, className="", style={}}){
  if(!name) return null;
  const s = { ...style };
  const cls = `icon ${className}`;
  return <span className={cls} style={{...s, WebkitMask:`url(./icons/${name}.svg) center/contain no-repeat`, mask:`url(./icons/${name}.svg) center/contain no-repeat`}}/>;
}

/* Image picker -> DataURL */
function pickImage(cb){
  const i=document.createElement('input'); i.type='file'; i.accept='image/*';
  i.onchange=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=> cb(String(r.result)); r.readAsDataURL(f);
  };
  i.click();
}

/* Font presets (linked to fonts/fonts.css variables you have) */
const FONT_PRESETS = [
  {label:"Default (Inter)", heading:"var(--font-inter)", body:"var(--font-inter)", meta:"var(--font-inter)", hWeight:600, subWeight:500},
  {label:"Serif Head / Sans Body", heading:"var(--font-serif)", body:"var(--font-system)", meta:"var(--font-system)", hWeight:600, subWeight:500},
  {label:"System Clean", heading:"var(--font-system)", body:"var(--font-system)", meta:"var(--font-system)", hWeight:600, subWeight:500},
];

/* =========================
   Migration & Safe Seed
   ========================= */
function migrateDoc(raw){
  const d = deepClone(raw) || {};
  // header
  d.header = d.header || { name:"JOHN DOE", role:"", email:"", phone:"", residence:"", birthdate:"", avatar:"" };
  d.summary = (typeof d.summary === 'string' ? d.summary : "Click to edit your profile summary.");
  d.sectionNames = d.sectionNames || {
    experience:"Experience", education:"Education", volunteering:"Volunteering", projects:"Projects",
    certifications:"Certifications", awards:"Awards", skills:"Skills", languages:"Languages",
    strengths:"Strengths", hobbies:"Hobbies", online:"Online", laws:"Laws"
  };

  // arrays
  const arrKeys = ["experience","education","volunteering","projects","certifications","awards","skills","languages","strengths","hobbies"];
  arrKeys.forEach(k=>{ if(!Array.isArray(d[k])) d[k]=[]; });

  d.online = d.online || {};
  d.laws = Array.isArray(d.laws) ? d.laws : (d.laws ? [String(d.laws)] : ["I authorize the processing of personal data in accordance with GDPR 2016/679."]);

  // theme
  d._theme = d._theme || {};
  d._theme.accent = d._theme.accent || "#2563eb";
  d._theme.fontSize = d._theme.fontSize || 11;
  d._theme.lineHeight = d._theme.lineHeight || 1.45;
  d._theme.headingFont = d._theme.headingFont || FONT_PRESETS[0].heading;
  d._theme.bodyFont = d._theme.bodyFont || FONT_PRESETS[0].body;
  d._theme.metaFont = d._theme.metaFont || FONT_PRESETS[0].meta;
  d._theme.hWeight = (d._theme.hWeight ?? 600);
  d._theme.subWeight = (d._theme.subWeight ?? 500);

  // layout: pages -> rows
  if (!Array.isArray(d._layout) || d._layout.length===0) {
    d._layout = [{
      id: rid(),
      page: 1,
      rows: [
        { id: rid(), type:"single", left:["headerSummary"], right:[] },
        { id: rid(), type:"23-13", left:["experience"], right:["skills","languages","online","laws"] },
        { id: rid(), type:"13-23", left:["certifications","awards","strengths","hobbies"], right:["education","volunteering","projects"] }
      ]
    }];
  } else {
    d._layout = d._layout.map(pg => ({
      id: pg?.id || rid(),
      page: typeof pg?.page === 'number' ? pg.page : 1,
      rows: Array.isArray(pg?.rows) ? pg.rows.map(r => ({
        id: r?.id || rid(),
        type: (["single","13-23","23-13"].includes(r?.type) ? r.type : "single"),
        left: Array.isArray(r?.left) ? r.left.filter(Boolean) : [],
        right: Array.isArray(r?.right) ? r.right.filter(Boolean) : []
      })) : [{ id:rid(), type:"single", left:[], right:[] }]
    }));
  }

  return d;
}

/* Storage helpers */
async function loadDoc(){
  const raw = await (window.StorageAPI?.load?.(docName, uid));
  const parsed = (raw && typeof raw === 'string')
    ? (() => { try { return JSON.parse(raw); } catch { return {}; } })()
    : raw;
  return migrateDoc(parsed);
}
async function saveDoc(data){ return window.StorageAPI?.save?.(docName, data, uid); }

/* =========================
   App
   ========================= */
function App(){
  /* Start with a safe document so the first render never crashes */
  const [s,setS] = useState(()=> migrateDoc(null));

  const [accent,setAccent] = useState(s._theme.accent);
  const [fontSize,setFontSize] = useState(s._theme.fontSize);
  const [lineHeight,setLineHeight] = useState(s._theme.lineHeight);
  const [headingFont,setHeadingFont] = useState(s._theme.headingFont);
  const [bodyFont,setBodyFont] = useState(s._theme.bodyFont);
  const [metaFont,setMetaFont] = useState(s._theme.metaFont);
  const [hWeight,setHWeight] = useState(s._theme.hWeight);
  const [subWeight,setSubWeight] = useState(s._theme.subWeight);

  /* Load the real doc once */
  useEffect(()=>{(async()=>{
    try{
      const d=await loadDoc();
      setS(d);
      if(d._theme){
        const t=d._theme;
        setAccent(t.accent); setFontSize(t.fontSize); setLineHeight(t.lineHeight);
        setHeadingFont(t.headingFont); setBodyFont(t.bodyFont); setMetaFont(t.metaFont);
        setHWeight(t.hWeight); setSubWeight(t.subWeight);
      }
    }catch(e){
      console.error('Load failed. Using safe seed.', e);
      setS(migrateDoc(null));
    }
  })();},[]);

  /* Push theme into CSS custom prop */
  useEffect(()=>{ document.documentElement.style.setProperty('--accent', accent); },[accent]);

  /* Attach theme onto doc when saving/printing */
  const withTheme = useCallback((doc)=>({
    ...doc,
    _theme:{ accent, fontSize, lineHeight, headingFont, bodyFont, metaFont, hWeight, subWeight }
  }),[accent,fontSize,lineHeight,headingFont,bodyFont,metaFont,hWeight,subWeight]);

  async function saveNow(){
    const payload = withTheme(s);
    await saveDoc?.(payload);
    alert('Saved');
  }

  function exportPDF(){
    const payload = withTheme(s);
    saveDoc?.(payload).then(()=>{
      document.body.classList.add('print-mode');
      window.print();
      setTimeout(()=>document.body.classList.remove('print-mode'), 300);
    });
  }

  /* Inline content editing */
  function CE({value, onChange, className="", style={}, placeholder=""}){
    const ref = useRef(null);
    return (
      <span
        className={`editable ${className}`}
        style={style}
        contentEditable
        suppressContentEditableWarning
        onBlur={(e)=> onChange?.(e.currentTarget.textContent || "")}
        onKeyDown={(e)=>{ if(e.key==="Enter"){ e.preventDefault(); e.currentTarget.blur(); } }}
        ref={ref}
      >
        {value || placeholder}
      </span>
    );
  }

  /* Move section between rows/columns */
  function removeFromRow(row, key, side){
    const arr = side==="left" ? row.left : row.right;
    const idx = arr.indexOf(key);
    if(idx>=0) arr.splice(idx,1);
  }
  function addToRow(row, key, side, pos='end'){
    const arr = side==="left" ? row.left : row.right;
    if (pos==='start') arr.unshift(key);
    else arr.push(key);
  }

  function moveSection({fromPage, fromRowId, fromSide, key, dir}){
    setS(prev=>{
      const draft = deepClone(prev);
      const pg = draft._layout.find(p=>p.page===fromPage);
      if(!pg) return prev;
      const rows = pg.rows;
      const i = rows.findIndex(r=>r.id===fromRowId);
      if(i<0) return prev;

      if(dir==='up' || dir==='down'){
        const j = dir==='up'? i-1 : i+1;
        if(j<0 || j>=rows.length) return prev;
        removeFromRow(rows[i], key, fromSide);
        addToRow(rows[j], key, fromSide, dir==='up'?'end':'start');
      }else if(dir==='swap'){
        removeFromRow(rows[i], key, fromSide);
        addToRow(rows[i], key, fromSide==='left'?'right':'left', 'end');
      }
      return draft;
    });
  }

  /* Row controls */
  function addRow(pageNum, type="single", afterRowId=null){
    setS(prev=>{
      const draft=deepClone(prev);
      const pg = draft._layout.find(p=>p.page===pageNum);
      if(!pg) return prev;
      const idx = afterRowId ? pg.rows.findIndex(r=>r.id===afterRowId) : (pg.rows.length-1);
      const row = { id:rid(), type, left:[], right:[] };
      pg.rows.splice(idx+1, 0, row);
      return draft;
    });
  }
  function deleteRow(pageNum, rowId){
    setS(prev=>{
      const draft=deepClone(prev);
      const pg = draft._layout.find(p=>p.page===pageNum);
      if(!pg) return prev;
      if(pg.rows.length<=1) return prev; // keep at least one row
      pg.rows = pg.rows.filter(r=>r.id!==rowId);
      return draft;
    });
  }
  function changeRowType(pageNum, rowId, type){
    setS(prev=>{
      const draft=deepClone(prev);
      const pg = draft._layout.find(p=>p.page===pageNum);
      if(!pg) return prev;
      const r = pg.rows.find(x=>x.id===rowId);
      if(!r) return prev;
      r.type = type;
      return draft;
    });
  }

  /* Pages */
  function addPage(){
    setS(prev=>{
      const draft = deepClone(prev);
      const maxPage = Math.max(...draft._layout.map(p=>p.page));
      draft._layout.push({
        id: rid(),
        page: maxPage+1,
        rows: [{ id:rid(), type:"single", left:[], right:[] }]
      });
      return draft;
    });
  }
  function deletePage(pageNum){
    setS(prev=>{
      const draft=deepClone(prev);
      if(draft._layout.length<=1) return prev;
      draft._layout = draft._layout.filter(p=>p.page!==pageNum);
      draft._layout.sort((a,b)=>a.page-b.page).forEach((p,i)=> p.page=i+1);
      return draft;
    });
  }

  /* Item-level reordering inside a section array */
  function moveItem(arrKey, idx, dir){
    setS(prev=>{
      const doc = deepClone(prev);
      const arr = doc[arrKey] || [];
      const j = dir==='up' ? idx-1 : idx+1;
      if (j<0 || j>=arr.length) return prev;
      [arr[idx],arr[j]]=[arr[j],arr[idx]];
      doc[arrKey]=arr;
      return doc;
    });
  }

  /* Helper: upload logo to arbitrary item */
  function setLogo(arrKey, idx, url){
    setS(prev=>{
      const doc = deepClone(prev);
      const arr = doc[arrKey] || [];
      if(!arr[idx]) return prev;
      arr[idx].logo = url;
      doc[arrKey]=arr;
      return doc;
    });
  }

  /* Title component */
  function SectionTitle({title}){
    return (
      <div className="mb-2">
        <div className="uppercase tracking-widest text-xs" style={{color:accent, fontFamily:headingFont, fontWeight:hWeight}}>{title}</div>
        <div className="title-divider"></div>
      </div>
    );
  }

  /* Renderers (inline editing on page) */
  const R = {
    headerSummary: ({page, rowId}) => (
      <div className="pb-4 border-b border-neutral-200">
        <div className="flex items-start gap-6">
          <div className="flex-1 min-w-0">
            <div className="text-3xl" style={{color:accent, fontFamily:headingFont, fontWeight:hWeight}}>
              <CE value={s.header.name} onChange={(v)=>setS(prev=>({...prev, header:{...prev.header, name:v}}))} placeholder="JOHN DOE"/>
            </div>
            <div className="text-lg" style={{color:"#0f172a", fontFamily:headingFont, fontWeight:subWeight}}>
              <CE value={s.header.role} onChange={(v)=>setS(prev=>({...prev, header:{...prev.header, role:v}}))} placeholder="Role / Position"/>
            </div>
            <div className="text-sm text-neutral-800 mt-2" style={{fontFamily:metaFont}}>
              <CE
                value={[s.header.email,s.header.phone,s.header.residence,s.header.birthdate].filter(Boolean).join(" • ")}
                onChange={(v)=> setS(prev=>({...prev, header:{...prev.header, metaLine:v}}))}
                placeholder="email • phone • city • birth"
              />
            </div>
          </div>
          <div className="w-24 h-24 rounded-full bg-neutral-100 border overflow-hidden flex items-center justify-center">
            {s.header.avatar
              ? <img src={s.header.avatar} className="w-full h-full object-cover" alt="avatar"/>
              : <span className="text-xs text-neutral-400">Photo</span>}
          </div>
        </div>
        <div className="mt-4 text-neutral-800" style={{lineHeight}}>
          <div
            className="editable"
            contentEditable
            suppressContentEditableWarning
            onBlur={(e)=> setS(prev=>({...prev, summary:e.currentTarget.textContent || ""}))}
          >{s.summary}</div>
        </div>
        <div className="mt-2 flex gap-2">
          <button className="chip" onClick={()=> pickImage(url=> setS(prev=>({...prev, header:{...prev.header, avatar:url}})) )}>Upload photo</button>
          {s.header.avatar && <button className="chip" onClick={()=> setS(prev=>({...prev, header:{...prev.header, avatar:""}}))}>Remove photo</button>}
        </div>
      </div>
    ),

    experience: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.experience}/>
        {(s.experience||[]).map((ex,i)=>{
          const logo = ex.logo;
          return (
            <div key={ex.id||i} className="mb-3" style={{fontFamily:bodyFont}}>
              <div className="flex items-start gap-3">
                {logo ? <div className="logo mt-0.5"><img src={logo} className="w-full h-full object-cover" alt=""/></div> : null}
                <div className="flex-1 min-w-0">
                  <div className="flex items-baseline justify-between gap-2">
                    <div style={{fontWeight:hWeight}}>
                      <CE value={ex.title} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.experience[i].title=v; return d;})} placeholder="Title"/>
                    </div>
                    <div className="text-sm meta">
                      <CE value={ex.period} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.experience[i].period=v; return d;})} placeholder="YYYY – YYYY"/>
                    </div>
                  </div>
                  <div className="text-sm">
                    <span style={{color:accent}}>
                      <CE value={ex.company} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.experience[i].company=v; return d;})} placeholder="Company"/>
                    </span>
                  </div>
                  <div className="text-sm meta mt-0.5 inline-flex items-center gap-2">
                    <Icon name="location" className="w-4 h-4"/>
                    <CE value={ex.location} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.experience[i].location=v; return d;})} placeholder="City, Country"/>
                  </div>
                  {(ex.bullets||[]).length>0 && (
                    <ul className="list-disc pl-5 mt-2 text-sm text-neutral-800">
                      {ex.bullets.map((b,j)=>
                        <li key={j}>
                          <CE value={b} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.experience[i].bullets[j]=v; return d;})} placeholder="Bullet"/>
                        </li>
                      )}
                    </ul>
                  )}
                  <div className="mt-2 flex flex-wrap gap-1">
                    <button className="chip" onClick={()=> moveItem('experience',i,'up')}>↑</button>
                    <button className="chip" onClick={()=> moveItem('experience',i,'down')}>↓</button>
                    <button className="chip" onClick={()=> pickImage(url=> setLogo('experience',i,url))}>Logo</button>
                    {logo && <button className="chip" onClick={()=> setLogo('experience',i,"")}>Remove logo</button>}
                    <button className="chip" onClick={()=> setS(prev=>{const d=deepClone(prev); d.experience[i].bullets=[...(d.experience[i].bullets||[]), ""]; return d;})}>+ Bullet</button>
                    <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.experience.splice(i,1); return d;})}>Delete</button>
                    <span className="ml-auto flex gap-1">
                      <button className="chip" title="Row up" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'experience', dir:'up'})}>Row↑</button>
                      <button className="chip" title="Row down" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'experience', dir:'down'})}>Row↓</button>
                      <button className="chip" title="Swap column" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'experience', dir:'swap'})}>⇆</button>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.experience.push({id:rid(), title:"", company:"", period:"", location:"", logo:"", bullets:[]}); return d;})}>+ Add experience</button>
      </section>
    ),

    education: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.education}/>
        {(s.education||[]).map((ed,i)=>(
          <div key={ed.id||i} className="mb-3" style={{fontFamily:bodyFont}}>
            <div className="flex justify-between items-baseline">
              <div className="mb-0.5" style={{fontWeight:hWeight}}>
                <CE value={ed.degree} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.education[i].degree=v; return d;})} placeholder="Degree"/>
              </div>
              <div className="text-sm meta">
                <CE value={ed.period} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.education[i].period=v; return d;})} placeholder="YYYY – YYYY"/>
                { (ed.gpa ? "  |  GPA " : "") }
                <CE value={ed.gpa||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.education[i].gpa=v; return d;})} placeholder="GPA"/>
              </div>
            </div>
            <div className="text-sm">
              <span style={{color:accent}}>
                <CE value={ed.school} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.education[i].school=v; return d;})} placeholder="University"/>
              </span>
            </div>
            <div className="text-sm meta mt-0.5 inline-flex items-center gap-2">
              <Icon name="location" className="w-4 h-4"/>
              <CE value={ed.location} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.education[i].location=v; return d;})} placeholder="City, Country"/>
            </div>

            <div className="mt-2 flex gap-1">
              <button className="chip" onClick={()=> moveItem('education',i,'up')}>↑</button>
              <button className="chip" onClick={()=> moveItem('education',i,'down')}>↓</button>
              <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.education.splice(i,1); return d;})}>Delete</button>
              <span className="ml-auto flex gap-1">
                <button className="chip" title="Row up" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'education', dir:'up'})}>Row↑</button>
                <button className="chip" title="Row down" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'education', dir:'down'})}>Row↓</button>
                <button className="chip" title="Swap column" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'education', dir:'swap'})}>⇆</button>
              </span>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.education.push({id:rid(), degree:"", school:"", period:"", location:"", gpa:""}); return d;})}>+ Add education</button>
      </section>
    ),

    volunteering: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.volunteering}/>
        {(s.volunteering||[]).map((v,i)=>{
          const logo=v.logo;
          return (
            <div key={v.id||i} className="mb-3" style={{fontFamily:bodyFont}}>
              <div className="flex items-start gap-3">
                {logo ? <div className="logo mt-0.5"><img src={logo} className="w-full h-full object-cover" alt=""/></div> : null}
                <div className="flex-1 min-w-0">
                  <div className="flex items-baseline justify-between gap-2">
                    <div style={{fontWeight:hWeight}}>
                      <CE value={v.role} onChange={(val)=>setS(prev=>{const d=deepClone(prev); d.volunteering[i].role=val; return d;})} placeholder="Role"/>
                    </div>
                    <div className="text-sm meta">
                      <CE value={v.period} onChange={(val)=>setS(prev=>{const d=deepClone(prev); d.volunteering[i].period=val; return d;})} placeholder="YYYY – YYYY"/>
                    </div>
                  </div>
                  <div className="text-sm"><span style={{color:accent}}>
                    <CE value={v.org} onChange={(val)=>setS(prev=>{const d=deepClone(prev); d.volunteering[i].org=val; return d;})} placeholder="Organization"/>
                  </span></div>
                  <div className="text-sm meta mt-0.5 inline-flex items-center gap-2">
                    <Icon name="location" className="w-4 h-4"/>
                    <CE value={v.location} onChange={(val)=>setS(prev=>{const d=deepClone(prev); d.volunteering[i].location=val; return d;})} placeholder="City, Country"/>
                  </div>
                  {(v.bullets||[]).length>0 && (
                    <ul className="list-disc pl-5 mt-2 text-sm text-neutral-800">
                      {v.bullets.map((b,j)=>
                        <li key={j}>
                          <CE value={b} onChange={(val)=>setS(prev=>{const d=deepClone(prev); d.volunteering[i].bullets[j]=val; return d;})} placeholder="Bullet"/>
                        </li>
                      )}
                    </ul>
                  )}
                  <div className="mt-2 flex flex-wrap gap-1">
                    <button className="chip" onClick={()=> moveItem('volunteering',i,'up')}>↑</button>
                    <button className="chip" onClick={()=> moveItem('volunteering',i,'down')}>↓</button>
                    <button className="chip" onClick={()=> pickImage(url=> setLogo('volunteering',i,url))}>Logo</button>
                    {logo && <button className="chip" onClick={()=> setLogo('volunteering',i,"")}>Remove logo</button>}
                    <button className="chip" onClick={()=> setS(prev=>{const d=deepClone(prev); d.volunteering[i].bullets=[...(d.volunteering[i].bullets||[]), ""]; return d;})}>+ Bullet</button>
                    <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.volunteering.splice(i,1); return d;})}>Delete</button>
                    <span className="ml-auto flex gap-1">
                      <button className="chip" title="Row up" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'volunteering', dir:'up'})}>Row↑</button>
                      <button className="chip" title="Row down" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'volunteering', dir:'down'})}>Row↓</button>
                      <button className="chip" title="Swap column" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'volunteering', dir:'swap'})}>⇆</button>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.volunteering.push({id:rid(), role:"", org:"", period:"", location:"", logo:"", bullets:[]}); return d;})}>+ Add volunteering</button>
      </section>
    ),

    projects: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.projects}/>
        {(s.projects||[]).map((p,i)=>(
          <div key={p.id||i} className="mb-3" style={{fontFamily:bodyFont}}>
            <div className="flex items-baseline justify-between gap-2">
              <div style={{fontWeight:hWeight}}>
                <CE value={p.name} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.projects[i].name=v; return d;})} placeholder="Project title"/>
              </div>
              <div className="text-sm meta">
                <CE value={p.period} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.projects[i].period=v; return d;})} placeholder="MM/YYYY – MM/YYYY"/>
              </div>
            </div>
            <div className="meta text-sm flex items-center gap-4" style={{color:"#6b7280"}}>
              <span className="inline-flex items-center gap-2">
                <Icon name="location" className="w-4 h-4"/>
                <CE value={p.location} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.projects[i].location=v; return d;})} placeholder="Place / Org"/>
              </span>
            </div>
            {p.domain && <div className="mt-1" style={{color:accent, fontWeight:hWeight}}>
              <CE value={p.domain} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.projects[i].domain=v; return d;})} placeholder="Domain (e.g., E-Health)"/>
            </div>}
            {(p.bullets||[]).length>0 && (
              <ul className="list-disc pl-5 mt-2 text-sm text-neutral-800">
                {p.bullets.map((b,j)=>
                  <li key={j}>
                    <CE value={b} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.projects[i].bullets[j]=v; return d;})} placeholder="Bullet"/>
                  </li>
                )}
              </ul>
            )}
            <div className="mt-2 flex gap-1">
              <button className="chip" onClick={()=> moveItem('projects',i,'up')}>↑</button>
              <button className="chip" onClick={()=> moveItem('projects',i,'down')}>↓</button>
              <button className="chip" onClick={()=> setS(prev=>{const d=deepClone(prev); d.projects[i].bullets=[...(d.projects[i].bullets||[]), ""]; return d;})}>+ Bullet</button>
              <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.projects.splice(i,1); return d;})}>Delete</button>
              <span className="ml-auto flex gap-1">
                <button className="chip" title="Row up" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'projects', dir:'up'})}>Row↑</button>
                <button className="chip" title="Row down" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'projects', dir:'down'})}>Row↓</button>
                <button className="chip" title="Swap column" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'projects', dir:'swap'})}>⇆</button>
              </span>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.projects.push({id:rid(), name:"", domain:"", period:"", location:"", bullets:[]}); return d;})}>+ Add project</button>
      </section>
    ),

    certifications: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.certifications}/>
        {(s.certifications||[]).map((c,i)=>(
          <div key={c.id||i} className="flex items-start gap-3 mb-3" style={{fontFamily:bodyFont}}>
            {c.logo ? <div className="logo mt-0.5"><img src={c.logo} className="w-full h-full object-cover" alt=""/></div>
                     : (c.icon ? <span className="circle-icon mt-0.5"><Icon name={c.icon} className="w-4 h-4"/></span> : null)}
            <div className="flex-1 min-w-0">
              <div style={{color:accent}}>
                <CE value={c.line1||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.certifications[i].line1=v; return d;})} placeholder="Certification title"/>
              </div>
              <div className="text-neutral-900">
                <CE value={c.line2||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.certifications[i].line2=v; return d;})} placeholder="Issuer / Notes"/>
              </div>
              <div className="mt-2 flex gap-1">
                <button className="chip" onClick={()=> moveItem('certifications',i,'up')}>↑</button>
                <button className="chip" onClick={()=> moveItem('certifications',i,'down')}>↓</button>
                <button className="chip" onClick={()=> pickImage(url=> setLogo('certifications',i,url))}>Logo</button>
                {c.logo && <button className="chip" onClick={()=> setLogo('certifications',i,"")}>Remove logo</button>}
                <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.certifications.splice(i,1); return d;})}>Delete</button>
                <span className="ml-auto flex gap-1">
                  <button className="chip" title="Row up" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'certifications', dir:'up'})}>Row↑</button>
                  <button className="chip" title="Row down" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'certifications', dir:'down'})}>Row↓</button>
                  <button className="chip" title="Swap column" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'certifications', dir:'swap'})}>⇆</button>
                </span>
              </div>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.certifications.push({id:rid(), icon:"certificate", logo:"", line1:"", line2:""}); return d;})}>+ Add certification</button>
      </section>
    ),

    awards: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.awards}/>
        {(s.awards||[]).map((a,i)=>(
          <div key={a.id||i} className="flex items-start gap-3 mb-3" style={{fontFamily:bodyFont}}>
            {a.logo ? <div className="logo mt-0.5"><img src={a.logo} className="w-full h-full object-cover" alt=""/></div>
                     : (a.icon ? <span className="circle-icon mt-0.5"><Icon name={a.icon} className="w-4 h-4"/></span> : null)}
            <div className="flex-1 min-w-0">
              <div className="text-neutral-900" style={{fontWeight:600}}>
                <CE value={a.line1||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.awards[i].line1=v; return d;})} placeholder="Award title"/>
              </div>
              <div className="text-neutral-900">
                <CE value={a.line2||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.awards[i].line2=v; return d;})} placeholder="Issuer / Notes"/>
              </div>
              <div className="mt-2 flex gap-1">
                <button className="chip" onClick={()=> moveItem('awards',i,'up')}>↑</button>
                <button className="chip" onClick={()=> moveItem('awards',i,'down')}>↓</button>
                <button className="chip" onClick={()=> pickImage(url=> setLogo('awards',i,url))}>Logo</button>
                {a.logo && <button className="chip" onClick={()=> setLogo('awards',i,"")}>Remove logo</button>}
                <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.awards.splice(i,1); return d;})}>Delete</button>
                <span className="ml-auto flex gap-1">
                  <button className="chip" title="Row up" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'awards', dir:'up'})}>Row↑</button>
                  <button className="chip" title="Row down" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'awards', dir:'down'})}>Row↓</button>
                  <button className="chip" title="Swap column" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'awards', dir:'swap'})}>⇆</button>
                </span>
              </div>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.awards.push({id:rid(), icon:"award", logo:"", line1:"", line2:""}); return d;})}>+ Add award</button>
      </section>
    ),

    skills: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.skills}/>
        {(s.skills||[]).map((g,i)=>(
          <div key={g.id||i} className="mb-3">
            <div className="text-sm" style={{fontFamily:headingFont, fontWeight:400}}>
              <CE value={g.group||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.skills[i].group=v; return d;})} placeholder="Group name"/>
            </div>
            <div className="mt-1 flex flex-wrap gap-2" style={{fontFamily:metaFont}}>
              {(g.items||[]).map((txt,j)=>(
                <span key={j} className="tag">
                  <CE value={txt} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.skills[i].items[j]=v; return d;})} placeholder="Skill"/>
                </span>
              ))}
            </div>
            <div className="mt-2 flex gap-1">
              <button className="chip" onClick={()=> setS(prev=>{const d=deepClone(prev); d.skills[i].items=[...(d.skills[i].items||[]), ""]; return d;})}>+ Skill</button>
              <button className="chip" onClick={()=> moveItem('skills',i,'up')}>↑</button>
              <button className="chip" onClick={()=> moveItem('skills',i,'down')}>↓</button>
              <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.skills.splice(i,1); return d;})}>Delete group</button>
              <span className="ml-auto flex gap-1">
                <button className="chip" title="Row up" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'skills', dir:'up'})}>Row↑</button>
                <button className="chip" title="Row down" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'skills', dir:'down'})}>Row↓</button>
                <button className="chip" title="Swap column" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'skills', dir:'swap'})}>⇆</button>
              </span>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.skills.push({id:rid(), group:"", items:[]}); return d;})}>+ Add group</button>
      </section>
    ),

    languages: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.languages}/>
        {(s.languages||[]).map((l,i)=>(
          <div key={l.id||i} className="flex items-center justify-between min-w-0 mb-2" style={{fontFamily:metaFont}}>
            <span className="truncate">
              <CE value={l.name||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.languages[i].name=v; return d;})} placeholder="Language"/>
            </span>
            <div className="flex items-center gap-2">
              <div className="flex gap-0.5">
                {Array.from({length:5}).map((_,k)=>
                  <span key={k}
                        className={`h-2 w-5 rounded ${k<(l.score||0)?'bg-neutral-800':'bg-neutral-300'}`}
                        onClick={()=> setS(prev=>{const d=deepClone(prev); d.languages[i].score = k+1; return d;})}
                        title={`Level ${k+1}/5`}/>
                )}
              </div>
              <span className="text-xs text-neutral-600">
                <CE value={l.level||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.languages[i].level=v; return d;})} placeholder="A1…C2"/>
              </span>
            </div>
            <div className="ml-2">
              <button className="chip" onClick={()=> moveItem('languages',i,'up')}>↑</button>
              <button className="chip" onClick={()=> moveItem('languages',i,'down')}>↓</button>
              <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.languages.splice(i,1); return d;})}>×</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.languages.push({id:rid(), name:"", score:3, level:""}); return d;})}>+ Add language</button>
      </section>
    ),

    strengths: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.strengths}/>
        {(s.strengths||[]).map((it,i)=>(
          <div key={it.id||i} className="flex items-center gap-2 mb-2" style={{fontFamily:bodyFont}}>
            {it.logo ? <div className="logo"><img src={it.logo} className="w-full h-full object-cover" alt=""/></div>
                     : (it.icon ? <span className="circle-icon"><Icon name={it.icon} className="w-4 h-4"/></span> : null)}
            <span>
              <CE value={it.label||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.strengths[i].label=v; return d;})} placeholder="Strength"/>
            </span>
            <div className="ml-auto flex gap-1">
              <button className="chip" onClick={()=> moveItem('strengths',i,'up')}>↑</button>
              <button className="chip" onClick={()=> moveItem('strengths',i,'down')}>↓</button>
              <button className="chip" onClick={()=> pickImage(url=> setLogo('strengths',i,url))}>Logo</button>
              {it.logo && <button className="chip" onClick={()=> setLogo('strengths',i,"")}>Remove logo</button>}
              <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.strengths.splice(i,1); return d;})}>×</button>
              <button className="chip" title="Row up" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'strengths', dir:'up'})}>Row↑</button>
              <button className="chip" title="Row down" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'strengths', dir:'down'})}>Row↓</button>
              <button className="chip" title="Swap column" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'strengths', dir:'swap'})}>⇆</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.strengths.push({id:rid(), icon:"bulb", logo:"", label:""}); return d;})}>+ Add strength</button>
      </section>
    ),

    hobbies: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.hobbies}/>
        {(s.hobbies||[]).map((it,i)=>(
          <div key={it.id||i} className="flex items-center gap-2 mb-2" style={{fontFamily:bodyFont}}>
            {it.logo ? <div className="logo"><img src={it.logo} className="w-full h-full object-cover" alt=""/></div>
                     : (it.icon ? <span className="circle-icon"><Icon name={it.icon} className="w-4 h-4"/></span> : null)}
            <span>
              <CE value={it.label||""} onChange={(v)=>setS(prev=>{const d=deepClone(prev); d.hobbies[i].label=v; return d;})} placeholder="Hobby"/>
            </span>
            <div className="ml-auto flex gap-1">
              <button className="chip" onClick={()=> moveItem('hobbies',i,'up')}>↑</button>
              <button className="chip" onClick={()=> moveItem('hobbies',i,'down')}>↓</button>
              <button className="chip" onClick={()=> pickImage(url=> setLogo('hobbies',i,url))}>Logo</button>
              {it.logo && <button className="chip" onClick={()=> setLogo('hobbies',i,"")}>Remove logo</button>}
              <button className="chip danger" onClick={()=> setS(prev=>{const d=deepClone(prev); d.hobbies.splice(i,1); return d;})}>×</button>
              <button className="chip" title="Row up" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'hobbies', dir:'up'})}>Row↑</button>
              <button className="chip" title="Row down" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'hobbies', dir:'down'})}>Row↓</button>
              <button className="chip" title="Swap column" onClick={()=> moveSection({fromPage:page, fromRowId:rowId, fromSide:side, key:'hobbies', dir:'swap'})}>⇆</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=> setS(prev=>{const d=deepClone(prev); d.hobbies.push({id:rid(), icon:"camera", logo:"", label:""}); return d;})}>+ Add hobby</button>
      </section>
    ),

    online: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.online}/>
        <div className="text-sm flex flex-col gap-2" style={{fontFamily:metaFont}}>
          <div className="flex items-center gap-2">
            <span className="circle-icon"><Icon name="linkedin" className="w-4 h-4"/></span>
            <CE value={s.online?.linkedin?.label||""} onChange={(v)=> setS(prev=>{const d=deepClone(prev); d.online.linkedin = d.online.linkedin || {}; d.online.linkedin.label=v; return d;})} placeholder="/in/johndoe"/>
          </div>
          <div className="flex items-center gap-2">
            <span className="circle-icon"><Icon name="github" className="w-4 h-4"/></span>
            <CE value={s.online?.github?.label||""} onChange={(v)=> setS(prev=>{const d=deepClone(prev); d.online.github = d.online.github || {}; d.online.github.label=v; return d;})} placeholder="github.com/you"/>
          </div>
          <div className="flex items-center gap-2">
            <span className="circle-icon"><Icon name="globe" className="w-4 h-4"/></span>
            <CE value={s.online?.website?.label||""} onChange={(v)=> setS(prev=>{const d=deepClone(prev); d.online.website = d.online.website || {}; d.online.website.label=v; return d;})} placeholder="yourdomain.com"/>
          </div>
        </div>
      </section>
    ),

    laws: ({page,rowId,side}) => (
      <section className="mb-4">
        <SectionTitle title={s.sectionNames.laws}/>
        <div className="text-xs text-neutral-500" style={{fontFamily:metaFont}}>
          <div
            className="editable"
            contentEditable
            suppressContentEditableWarning
            onBlur={(e)=> setS(prev=>({...prev, laws: [e.currentTarget.textContent||""]}))}
          >{(s.laws||[]).join('\n')}</div>
        </div>
      </section>
    ),
  };

  /* Toolbar & Controls */
  function TemplatePicker(){
    const list = (window.CV_TEMPLATES?.list?.() || [{id:'default',name:'Default'}]);
    return (
      <select className="input" onChange={(e)=>{
        const t=window.CV_TEMPLATES?.get?.(e.target.value)||window.CV_TEMPLATES?.get?.('default');
        const merged = t?.migrate ? t.migrate(s) : s;
        if (merged) setS(merged);
      }}>
        {list.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}
      </select>
    );
  }

  return (
    <div className="min-h-screen grid grid-cols-1 xl:grid-cols-[420px,1fr] gap-6">
      {/* TOP BAR */}
      <header id="toolbar" className="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-neutral-200">
        <div className="max-w-[1600px] mx-auto px-4 py-2 flex items-center gap-2">
          <a className="btn" href="./home.html">← Home</a>
          <div className="font-semibold tracking-tight">CV Studio</div>
          <span className="text-neutral-400">/</span>
          <div className="truncate">{docName}</div>
          <div className="ml-auto flex items-center gap-2">
            <button className="btn" onClick={saveNow}>Save</button>
            <button className="btn-primary" onClick={exportPDF}>Export PDF</button>
          </div>
        </div>

        <div className="max-w-[1600px] mx-auto px-4 pb-2 grid grid-cols-1 md:grid-cols-7 gap-2">
          <div className="flex items-center gap-2">
            <span className="text-xs text-neutral-600">Template</span>
            <TemplatePicker/>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-xs text-neutral-600">Font preset</span>
            <select className="input" onChange={e=>{
              const p = FONT_PRESETS[parseInt(e.target.value)]||FONT_PRESETS[0];
              setHeadingFont(p.heading); setBodyFont(p.body); setMetaFont(p.meta); setHWeight(p.hWeight); setSubWeight(p.subWeight);
            }}>
              {FONT_PRESETS.map((p,i)=><option key={p.label} value={i}>{p.label}</option>)}
            </select>
          </div>
          <div className="flex items-center gap-2"><span className="text-xs text-neutral-600">Size</span><input className="range" type="range" min="9" max="14" step="1" value={fontSize} onChange={e=>setFontSize(parseInt(e.target.value))}/></div>
          <div className="flex items-center gap-2"><span className="text-xs text-neutral-600">Line</span><input className="range" type="range" min="1.2" max="1.8" step="0.05" value={lineHeight} onChange={e=>setLineHeight(parseFloat(e.target.value))}/></div>
          <div className="flex items-center gap-2"><span className="text-xs text-neutral-600">Accent</span><input className="color-swatch" type="color" value={accent} onChange={e=>setAccent(e.target.value)}/></div>
          <div className="flex items-center gap-2"><span className="text-xs text-neutral-600">Photo</span><button className="btn" onClick={()=>pickImage(url=>setS(prev=>({...prev,header:{...prev.header,avatar:url}})))}>Upload</button></div>
          <div className="flex items-center gap-2">
            <span className="text-xs text-neutral-600">Pages</span>
            <button className="btn" onClick={addPage}>+ Page</button>
            {s._layout.length>1 && <button className="btn-danger" onClick={()=> deletePage(s._layout[s._layout.length-1].page)}>– Last</button>}
          </div>
        </div>
      </header>

      {/* LEFT: Section name editor & quick add */}
      <aside id="leftPane" className="px-4">
        <div className="sticky top-[110px]">
          <div className="sidebar-scroll">
            <div className="card p-4 mb-4">
              <div className="font-semibold mb-2">Section labels</div>
              {Object.keys(s.sectionNames).map(k=>(
                <div key={k} className="text-sm grid grid-cols-[120px,1fr] items-center gap-2 mb-1">
                  <div className="text-neutral-500">{k}</div>
                  <input className="input" value={s.sectionNames[k]} onChange={(e)=> setS(prev=>{const d=deepClone(prev); d.sectionNames[k]=e.target.value; return d;})}/>
                </div>
              ))}
            </div>

            <div className="card p-4 mb-4">
              <div className="font-semibold mb-2">Add rows / layout</div>
              {s._layout.map(pg=>(
                <div key={pg.id} className="mb-3">
                  <div className="text-sm font-medium">Page {pg.page}</div>
                  {pg.rows.map(r=>(
                    <div key={r.id} className="flex items-center gap-2 mt-1">
                      <select className="input" value={r.type} onChange={(e)=> changeRowType(pg.page, r.id, e.target.value)}>
                        <option value="single">Single</option>
                        <option value="13-23">1/3 – 2/3</option>
                        <option value="23-13">2/3 – 1/3</option>
                      </select>
                      <button className="btn" onClick={()=> addRow(pg.page, r.type, r.id)}>+ below</button>
                      {pg.rows.length>1 && <button className="btn-danger" onClick={()=> deleteRow(pg.page, r.id)}>Delete row</button>}
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>
        </div>
      </aside>

      {/* RIGHT: A4 Pages */}
      <section className="px-4">
        <div className="flex flex-col items-center gap-6 py-4">
          {(s._layout || []).sort((a,b)=>a.page-b.page).map((pg)=>(
            <div key={pg.id} className="sheet card p-10" style={{lineHeight, fontFamily:bodyFont, fontSize:`${fontSize}pt`}}>
              {(pg.rows || []).map((row)=>(
                <div key={row.id} className={`grid-band ${row.type==='single'?'band-single':row.type==='13-23'?'band-13-23':'band-23-13'}`} style={{marginBottom:"18px"}}>
                  <div>
                    {(row.left||[]).map((secKey, idx)=>(
                      <div key={secKey+'-'+idx}>
                        {R[secKey] ? R[secKey]({page:pg.page, rowId:row.id, side:'left'}) : <div className="text-sm text-red-600">Unknown section: {secKey}</div>}
                      </div>
                    ))}
                  </div>
                  {row.type!=='single' && (
                    <div>
                      {(row.right||[]).map((secKey, idx)=>(
                        <div key={secKey+'-'+idx}>
                          {R[secKey] ? R[secKey]({page:pg.page, rowId:row.id, side:'right'}) : <div className="text-sm text-red-600">Unknown section: {secKey}</div>}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          ))}
        </div>
      </section>
    </div>
  );
}

/* Mount */
function mountApp(){
  try{
    const rootEl = document.getElementById('root');
    if(!rootEl){ console.error('No #root element'); return; }
    ReactDOM.createRoot(rootEl).render(<App/>);
  }catch(e){
    console.error('Editor bootstrap failed:', e);
    const r=document.getElementById('root');
    if(r) r.innerHTML='<div style="padding:16px;color:#b91c1c;">Editor failed. Check the console.</div>';
  }
}
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', mountApp);
else mountApp();
</script>
</body>
</html>