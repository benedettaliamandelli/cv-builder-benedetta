<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CV Studio — Editor</title>

<link rel="stylesheet" href="./styles.css"/>
<link rel="stylesheet" href="./fonts/fonts.css"/>

<!-- Tailwind + React + Babel (fine for GH Pages; for prod, prebuild) -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase (optional) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Storage/Auth shims (your files) -->
<script src="./auth.firebase.js"></script>
<script src="./storage.firebase.js"></script>
<script src="./storage.local.js"></script>

<!-- Templates (your files) -->
<script src="./templates/default.js?v=20251019"></script>
<script src="./templates/minimal.js?v=20251019"></script>

<style>
  :root{
    --rule:#d1d5db;
    --accent:#2563eb;
    --toolbar-h: 96px; /* two rows */
  }
  /* small UI helpers */
  .btn{ padding:.45rem .75rem; border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; }
  .btn:hover{ background:#f9fafb; }
  .btn-primary{ padding:.5rem .85rem; border-radius:.55rem; background:#111827; color:#fff; border:1px solid #111827; }
  .btn-danger{ padding:.45rem .75rem; border:1px solid #fecaca; background:#fee2e2; color:#991b1b; border-radius:.5rem; }
  .input{ border:1px solid #e5e7eb; border-radius:.45rem; padding:.35rem .6rem; background:#fff; min-width:0; }
  .color{ width:40px; height:32px; padding:0; border:1px solid #e5e7eb; border-radius:.45rem; }

  body{ background:#f8fafc; }
  body.has-toolbar{ padding-top:var(--toolbar-h); }

  /* sticky toolbar (two rows) */
  #toolbar{ position:fixed; top:0; left:0; right:0; z-index:40; background:rgba(255,255,255,.9);
            backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid #e5e7eb; }
  .toolbar-row{ max-width:1600px; margin:0 auto; padding:.5rem 1rem; display:grid; gap:.5rem; }
  .toolbar-row.row1{ grid-template-columns:auto 1fr auto; align-items:center; }
  .toolbar-row.row2{ grid-template-columns:repeat(12, minmax(0,1fr)); align-items:center; }

  /* A4 preview with two columns (no overlap) */
  .sheet{
    width:210mm; min-height:297mm; margin:14mm auto; background:#fff; color:#111827;
    box-shadow:0 10px 25px rgba(0,0,0,.06);
    padding:20mm;
    display:grid; grid-template-columns: 1fr 2fr; gap:12mm;
    font-family:"Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    font-size:var(--fs,11pt); line-height:var(--lh,1.45);
  }
  .title-divider{ height:1px; background:var(--rule); margin:.35rem 0 .8rem; }
  .meta{ color:#6b7280; }
  .editable[contenteditable="true"]{ cursor:text; }
  .editable[contenteditable="true"]:focus{ outline:2px solid var(--accent); outline-offset:1px; }

  .avatar{ width:92px; height:92px; border-radius:9999px; overflow:hidden; border:1px solid #e5e7eb; background:#f3f4f6;
           display:flex; align-items:center; justify-content:center; }

  /* icon as mask (inherits color) */
  .icon{ display:inline-block; width:1em; height:1em; background:currentColor; -webkit-mask:center/contain no-repeat; mask:center/contain no-repeat; }
  .circle-icon{ display:inline-flex; align-items:center; justify-content:center; width:26px; height:26px; border-radius:9999px; background:#e5e7eb; color:var(--accent); }

  /* Print */
  @media print{
    html, body{ background:#fff!important; margin:0!important; }
    #toolbar{ display:none!important; }
    .sheet{ box-shadow:none!important; margin:0 auto; page-break-after:always; break-after:page; }
    .sheet:last-child{ page-break-after:auto; }
    @page{ size:A4; margin:14mm; }
  }
</style>
</head>
<body class="has-toolbar">
<div id="root"></div>

<script type="text/babel">
/* ---------- SAFE UTILS (no crash in older browsers) ---------- */
const {useState, useEffect, useRef} = React;
const rid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
const param = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{return d;} };
const uid = param('uid', null);
const docName = param('doc','Default');
const deepClone = (obj)=> {
  if (typeof structuredClone === 'function') return structuredClone(obj);
  return JSON.parse(JSON.stringify(obj));
};

/* robust StorageAPI fallback */
(function ensureStorageAPI(){
  if (window.StorageAPI) return;
  window.StorageAPI = {
    list: async ()=> Object.keys(localStorage).filter(k=>k.startsWith('cvdoc:')).map(k=>k.replace('cvdoc:','')).sort(),
    save: async (name,data)=> { localStorage.setItem('cvdoc:'+name, JSON.stringify(data)); return true; },
    load: async (name)=> { const raw=localStorage.getItem('cvdoc:'+name); return raw? JSON.parse(raw): null; },
    remove: async (name)=> { localStorage.removeItem('cvdoc:'+name); return true; }
  };
})();

/* robust templates fallback */
(function ensureTemplates(){
  if (!window.CV_TEMPLATES) {
    const blankSeed = ()=>({
      header:{name:"JOHN DOE", role:"", email:"", phone:"", residence:"", birthdate:"", avatar:""},
      summary:"",
      sectionNames:{experience:"Experience",education:"Education",projects:"Projects",volunteering:"Volunteering",skills:"Skills",languages:"Languages",strengths:"Strengths",hobbies:"Hobbies",online:"Online",certifications:"Certifications",awards:"Awards",laws:"Laws"},
      experience:[], education:[], projects:[], volunteering:[],
      skills:[], languages:[], strengths:[], hobbies:[],
      online:{}, certifications:[], awards:[],
      laws:["I authorize the processing of personal data in accordance with GDPR 2016/679."],
      _theme:{accent:"#2563eb", fs:11, lh:1.45, heading:"var(--font-inter)", body:"var(--font-inter)", meta:"var(--font-inter)", h:600, sub:500}
    });
    window.CV_TEMPLATES = {
      _map: { default: { id:'default', name:'Default', seed:blankSeed, migrate:(s)=>s }, minimal:{ id:'minimal', name:'Minimal', seed:blankSeed, migrate:(s)=>s } },
      list(){ return Object.values(this._map); },
      get(id){ return this._map[id] || this._map.default; }
    };
  }
})();

/* loaders */
async function loadDoc(){
  const tpl = window.CV_TEMPLATES.get('default');
  const seed = tpl?.seed || (()=>({}));
  return (await window.StorageAPI.load(docName, uid)) || seed();
}
async function saveDoc(data){ return window.StorageAPI.save(docName, data, uid); }

/* pick image */
function pickImage(cb){
  const i=document.createElement('input'); i.type='file'; i.accept='image/*';
  i.onchange=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>cb(String(r.result)); r.readAsDataURL(f);
  };
  i.click();
}
/* Icon component */
function Icon({name, className="", style={}}){
  if(!name) return null;
  return <span className={"icon "+className} style={{...style, WebkitMask:`url(./icons/${name}.svg)`, mask:`url(./icons/${name}.svg)`}}/>;
}

/* font presets */
const FONT_PRESETS = [
  {label:"Inter (default)", fs:11, lh:1.45, heading:"var(--font-inter)", body:"var(--font-inter)", meta:"var(--font-inter)", h:600, sub:500},
  {label:"System Clean", fs:11, lh:1.45, heading:"var(--font-system)", body:"var(--font-system)", meta:"var(--font-system)", h:600, sub:500},
  {label:"Serif Head", fs:11, lh:1.45, heading:"var(--font-serif)", body:"var(--font-system)", meta:"var(--font-system)", h:600, sub:500}
];

/* ---------- APP ---------- */
function App(){
  const [state,setState] = useState(null);

  /* theme controls */
  const [accent,setAccent] = useState("#2563eb");
  const [fs,setFs] = useState(11);
  const [lh,setLh] = useState(1.45);
  const [hFont,setHFont] = useState("var(--font-inter)");
  const [bFont,setBFont] = useState("var(--font-inter)");
  const [mFont,setMFont] = useState("var(--font-inter)");
  const [hWeight,setHWeight] = useState(600);
  const [subWeight,setSubWeight] = useState(500);

  /* load once */
  useEffect(()=>{(async()=>{
    try{
      const d = await loadDoc();
      setState(d);
      const t=d._theme||{};
      setAccent(t.accent ?? "#2563eb");
      setFs(t.fs ?? 11);
      setLh(t.lh ?? 1.45);
      setHFont(t.heading || "var(--font-inter)");
      setBFont(t.body || "var(--font-inter)");
      setMFont(t.meta || "var(--font-inter)");
      setHWeight(t.h ?? 600);
      setSubWeight(t.sub ?? 500);
    }catch(e){
      console.error("Load failed", e);
      const fallback = window.CV_TEMPLATES.get('default').seed();
      setState(fallback);
    }
  })();},[]);

  /* debounced autosave */
  const saveTimer = useRef(null);
  function scheduleSave(next){
    clearTimeout(saveTimer.current);
    saveTimer.current = setTimeout(()=>{
      saveDoc(next).catch(()=>{});
    }, 600);
  }

  if(!state) return <div className="p-6 text-neutral-600">Loading…</div>;

  /* inline edit helper */
  function setPath(path, value){
    const parts = path.split('.');
    setState(prev=>{
      const copy = deepClone(prev);
      let t = copy;
      for(let i=0;i<parts.length-1;i++){ t = t[parts[i]]; }
      t[parts.at(-1)] = value;
      copy._theme = {accent, fs, lh, heading:hFont, body:bFont, meta:mFont, h:hWeight, sub:subWeight};
      scheduleSave(copy);
      return copy;
    });
  }

  /* section title */
  function SectionTitle({children}){
    return (
      <div className="mb-2">
        <div className="uppercase tracking-widest text-[11px]"
             style={{color:accent, fontFamily:hFont, fontWeight:hWeight}}>
          {children}
        </div>
        <div className="title-divider"></div>
      </div>
    );
  }

  /* ----- TOOLBAR (2 rows) ----- */
  const row1 = (
    <div className="toolbar-row row1">
      <div className="flex items-center gap-2">
        <a className="btn" href="./home.html">← Home</a>
        <div className="font-semibold">CV Studio</div>
        <span className="text-neutral-400">/</span>
        <div className="truncate">{docName}</div>
      </div>
      <div></div>
      <div className="flex items-center gap-2">
        <button className="btn" onClick={()=>saveDoc({...state, _theme:{accent,fs,lh,heading:hFont,body:bFont,meta:mFont,h:hWeight,sub:subWeight}})}>Save</button>
        <button className="btn-primary" onClick={()=>window.print()}>Export PDF</button>
      </div>
    </div>
  );

  const row2 = (
    <div className="toolbar-row row2">
      {/* Template selector */}
      <div className="col-span-3 flex items-center gap-2 min-w-0">
        <span className="text-xs text-neutral-500 shrink-0">Template</span>
        <select className="input w-full"
          onChange={e=>{
            const id=e.target.value;
            const tpl=window.CV_TEMPLATES?.get?.(id);
            if(!tpl) return;
            const migrated = tpl.migrate ? tpl.migrate(state) : state;
            setState(migrated);
            scheduleSave(migrated);
          }}>
          {(window.CV_TEMPLATES?.list?.()||[{id:'default',name:'Default'}]).map(t=>
            <option key={t.id} value={t.id}>{t.name}</option>
          )}
        </select>
      </div>

      {/* Fonts preset */}
      <div className="col-span-3 flex items-center gap-2 min-w-0">
        <span className="text-xs text-neutral-500 shrink-0">Font preset</span>
        <select className="input w-full"
          onChange={e=>{
            const p = FONT_PRESETS[parseInt(e.target.value)] || FONT_PRESETS[0];
            setFs(p.fs); setLh(p.lh); setHFont(p.heading); setBFont(p.body); setMFont(p.meta); setHWeight(p.h); setSubWeight(p.sub);
          }}>
          {FONT_PRESETS.map((p,i)=><option key={p.label} value={i}>{p.label}</option>)}
        </select>
      </div>

      {/* Font size */}
      <div className="col-span-2 flex items-center gap-2">
        <span className="text-xs text-neutral-500">Size</span>
        <input className="w-full" type="range" min="9" max="14" step="1" value={fs}
               onChange={e=>setFs(parseInt(e.target.value))}/>
        <span className="text-xs w-8 text-right">{fs}pt</span>
      </div>

      {/* Line height */}
      <div className="col-span-2 flex items-center gap-2">
        <span className="text-xs text-neutral-500">Line</span>
        <input className="w-full" type="range" min="1.2" max="1.8" step="0.05" value={lh}
               onChange={e=>setLh(parseFloat(e.target.value))}/>
      </div>

      {/* Accent color */}
      <div className="col-span-1 flex items-center gap-2">
        <span className="text-xs text-neutral-500">Accent</span>
        <input className="color" type="color" value={accent} onChange={e=>setAccent(e.target.value)}/>
      </div>

      {/* Photo */}
      <div className="col-span-1 flex items-center gap-2">
        <span className="text-xs text-neutral-500">Photo</span>
        <button className="btn" onClick={()=>pickImage(url=>setPath('header.avatar',url))}>Upload</button>
      </div>
    </div>
  );

  /* ------------- RENDER ------------- */
  return (
    <>
      <header id="toolbar">
        {row1}
        {row2}
      </header>

      <main>
        <div className="sheet"
             style={{'--fs': fs+'pt', '--lh': lh, '--accent': accent, fontFamily: bFont}}>
          {/* LEFT column */}
          <div>
            {/* Header block */}
            <div className="flex items-start gap-4 mb-4">
              <div className="flex-1 min-w-0">
                <div className="editable text-3xl leading-tight font-bold text-[var(--accent)]"
                     style={{fontFamily:hFont, fontWeight:hWeight}}
                     contentEditable suppressContentEditableWarning
                     onBlur={e=>setPath('header.name', e.target.textContent)}>
                  {state.header.name}
                </div>

                <div className="editable text-lg"
                     style={{fontFamily:hFont, fontWeight:subWeight}}
                     contentEditable suppressContentEditableWarning
                     onBlur={e=>setPath('header.role', e.target.textContent)}>
                  {state.header.role}
                </div>

                <div className="text-sm mt-2" style={{fontFamily:mFont}}>
                  {[
                    state.header.email, state.header.phone,
                    state.header.residence, state.header.birthdate
                  ].filter(Boolean).join(' • ')}
                </div>
              </div>

              <div className="avatar">
                {state.header.avatar
                  ? <img src={state.header.avatar} className="w-full h-full object-cover" alt="avatar"/>
                  : <span className="text-xs text-neutral-400">Photo</span>}
              </div>
            </div>

            {/* Summary */}
            <div className="editable text-sm text-neutral-800 mb-6 whitespace-pre-line"
                 contentEditable suppressContentEditableWarning
                 onBlur={e=>setPath('summary', e.target.textContent)}>
              {state.summary}
            </div>

            {/* Skills */}
            <SectionTitle>{state.sectionNames.skills || 'SKILLS'}</SectionTitle>
            <div className="mb-6">
              {state.skills.map((g,i)=>(
                <div key={i} className="mb-2">
                  <div className="editable text-sm font-medium"
                       style={{fontFamily:hFont, fontWeight:400}}
                       contentEditable suppressContentEditableWarning
                       onBlur={e=>{
                         const v=deepClone(state.skills); v[i].group=e.target.textContent;
                         const next={...state, skills:v}; setState(next); scheduleSave(next);
                       }}>
                    {g.group}
                  </div>
                  <div className="mt-1 flex flex-wrap gap-1" style={{fontFamily:mFont}}>
                    {(g.items||[]).map((s,j)=><span key={j} className="px-2 py-0.5 border rounded-full text-sm">{s}</span>)}
                  </div>
                </div>
              ))}
            </div>

            {/* Languages */}
            <SectionTitle>{state.sectionNames.languages || 'LANGUAGES'}</SectionTitle>
            <div className="mb-6">
              {(state.languages||[]).map((l,i)=>(
                <div key={i} className="flex items-center justify-between text-sm mb-1" style={{fontFamily:mFont}}>
                  <span className="editable truncate" contentEditable suppressContentEditableWarning
                        onBlur={e=>{
                          const v=deepClone(state.languages); v[i].name=e.target.textContent;
                          const next={...state, languages:v}; setState(next); scheduleSave(next);
                        }}>{l.name}</span>
                  <span className="text-xs meta ml-3">{l.level}</span>
                </div>
              ))}
            </div>

            {/* Strengths */}
            <SectionTitle>{state.sectionNames.strengths || 'STRENGTHS'}</SectionTitle>
            <div className="mb-6">
              {(state.strengths||[]).map((it,i)=><div key={i} className="text-sm mb-1">{it.label}</div>)}
            </div>

            {/* Hobbies */}
            <SectionTitle>{state.sectionNames.hobbies || 'HOBBIES'}</SectionTitle>
            <div className="mb-6">
              {(state.hobbies||[]).map((it,i)=><div key={i} className="text-sm mb-1">{it.label}</div>)}
            </div>

            {/* Online */}
            <SectionTitle>{state.sectionNames.online || 'ONLINE'}</SectionTitle>
            <div className="mb-6 text-sm" style={{fontFamily:mFont}}>
              {state.online?.linkedin?.url && <div>LinkedIn: {state.online.linkedin.url}</div>}
              {state.online?.github?.url && <div>GitHub: {state.online.github.url}</div>}
              {state.online?.website?.url && <div>Website: {state.online.website.url}</div>}
            </div>

            {/* Laws */}
            <SectionTitle>{state.sectionNames.laws || 'LAWS'}</SectionTitle>
            <div className="text-xs text-neutral-600 whitespace-pre-line">
              {(state.laws||[]).join('\n')}
            </div>
          </div>

          {/* RIGHT column */}
          <div>
            {/* Experience */}
            <SectionTitle>{state.sectionNames.experience || 'EXPERIENCE'}</SectionTitle>
            <div className="mb-6">
              {state.experience.map((ex,i)=>(
                <div key={ex.id} className="mb-4">
                  <div className="editable font-medium text-sm"
                       contentEditable suppressContentEditableWarning
                       onBlur={e=>{
                         const v=deepClone(state.experience); v[i].title=e.target.textContent;
                         const next={...state, experience:v}; setState(next); scheduleSave(next);
                       }}>{ex.title}</div>
                  <div className="text-sm" style={{color:accent}}>{ex.company}</div>
                  <div className="text-xs meta mb-1">{ex.period} • {ex.location}</div>
                  {(ex.bullets||[]).length>0 &&
                    <ul className="list-disc pl-5 text-sm text-neutral-800">
                      {ex.bullets.map((b,j)=><li key={j}>{b}</li>)}
                    </ul>}
                </div>
              ))}
            </div>

            {/* Education */}
            <SectionTitle>{state.sectionNames.education || 'EDUCATION'}</SectionTitle>
            <div className="mb-6">
              {state.education.map((ed,i)=>(
                <div key={ed.id} className="mb-3">
                  <div className="font-medium text-sm">{ed.degree}</div>
                  <div className="text-sm" style={{color:accent}}>{ed.school}</div>
                  <div className="text-xs meta">{ed.period} • {ed.location}{ed.gpa?` • GPA ${ed.gpa}`:''}</div>
                </div>
              ))}
            </div>

            {/* Projects */}
            <SectionTitle>{state.sectionNames.projects || 'PROJECTS'}</SectionTitle>
            <div className="mb-6">
              {state.projects.map((p,i)=>(
                <div key={p.id} className="mb-3">
                  <div className="font-medium text-sm">{p.name}</div>
                  {p.domain && <div className="text-sm" style={{color:accent}}>{p.domain}</div>}
                  <div className="text-xs meta">{p.period} • {p.location}</div>
                  {(p.bullets||[]).length>0 &&
                    <ul className="list-disc pl-5 text-sm text-neutral-800">
                      {p.bullets.map((b,j)=><li key={j}>{b}</li>)}
                    </ul>}
                </div>
              ))}
            </div>

            {/* Certifications */}
            <SectionTitle>{state.sectionNames.certifications || 'CERTIFICATIONS'}</SectionTitle>
            <div className="mb-6">
              {state.certifications.map((c,i)=>(
                <div key={c.id} className="mb-2">
                  <div className="text-sm" style={{color:accent}}>{c.line1}</div>
                  {c.line2 && <div className="text-sm">{c.line2}</div>}
                </div>
              ))}
            </div>

            {/* Awards */}
            <SectionTitle>{state.sectionNames.awards || 'AWARDS'}</SectionTitle>
            <div className="mb-6">
              {state.awards.map((a,i)=>(
                <div key={a.id} className="mb-2">
                  <div className="font-medium text-sm">{a.line1}</div>
                  {a.line2 && <div className="text-sm">{a.line2}</div>}
                </div>
              ))}
            </div>
          </div>
        </div>
      </main>
    </>
  );
}

/* mount safely */
(function mount(){
  try{
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  }catch(e){
    console.error("Editor failed to mount:", e);
    const r=document.getElementById('root');
    if(r) r.innerHTML='<div style="padding:16px;color:#b91c1c;">Editor failed to load. Open the console for details.</div>';
  }
})();
</script>
</body>
</html>