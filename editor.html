<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CV Studio — Editor</title>

<link rel="stylesheet" href="./styles.css"/>
<link rel="stylesheet" href="./fonts/fonts.css"/>

<!-- Minimal safety styles -->
<style>
  :root{ --accent:#2563eb; --rule:#d1d5db; --toolbar-h:120px; }
  body{ background:#f8fafc; padding-top:var(--toolbar-h); }
  #toolbar{ position:fixed; top:0; left:0; right:0; z-index:50; background:rgba(255,255,255,.92); backdrop-filter:blur(8px); border-bottom:1px solid #e5e7eb; }
  .row{ max-width:1600px; margin:0 auto; padding:.5rem 1rem; display:grid; gap:.5rem; }
  .row.top{ grid-template-columns:auto 1fr auto; align-items:center; }
  .row.controls{ grid-template-columns:repeat(12,minmax(0,1fr)); align-items:center; }
  .btn{ padding:.45rem .7rem; border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; }
  .btn:hover{ background:#f9fafb; }
  .btn-primary{ padding:.48rem .85rem; border:1px solid #111827; border-radius:.55rem; background:#111827; color:#fff; }
  .btn-danger{ padding:.45rem .7rem; border:1px solid #fecaca; border-radius:.5rem; background:#fee2e2; color:#991b1b; }
  .chip{ padding:.15rem .45rem; border:1px solid #e5e7eb; border-radius:.4rem; background:#fff; font-size:.8rem; }
  .input{ border:1px solid #e5e7eb; border-radius:.45rem; padding:.35rem .6rem; background:#fff; min-width:0; }
  .color{ width:40px; height:32px; padding:0; border:1px solid #e5e7eb; border-radius:.45rem; }

  /* A4 sheet */
  .sheet{ width:210mm; min-height:297mm; margin:14mm auto; background:#fff; color:#111827;
          box-shadow:0 10px 25px rgba(0,0,0,.06); padding:18mm; font-size:var(--fs,11pt); line-height:var(--lh,1.45);
          display:flex; flex-direction:column; gap:10mm; }
  .band{ display:grid; gap:10mm; }
  .band.single{ grid-template-columns:1fr; }
  .band.c13-23{ grid-template-columns:1fr 2fr; }
  .band.c23-13{ grid-template-columns:2fr 1fr; }
  .col{ display:flex; flex-direction:column; gap:6mm; }

  .secbar{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.2rem; }
  .secbar .title{ text-transform:uppercase; letter-spacing:.08em; font-size:11px; color:var(--accent); }
  .title-divider{ height:1px; background:var(--rule); margin:.3rem 0 .7rem; }
  .meta{ color:#6b7280; }

  .editable[contenteditable="true"]{ cursor:text; }
  .editable[contenteditable="true"]:focus{ outline:2px solid var(--accent); outline-offset:1px; }

  .avatar{ width:96px; height:96px; border-radius:9999px; overflow:hidden; border:1px solid #e5e7eb; background:#f3f4f6; display:flex; align-items:center; justify-content:center; }
  .logo{ width:32px; height:32px; border-radius:9999px; overflow:hidden; border:1px solid #e5e7eb; background:#f3f4f6; flex:0 0 auto; }
  .icon{ display:inline-block; width:1em; height:1em; background:currentColor; -webkit-mask:center/contain no-repeat; mask:center/contain no-repeat; }
  .circle-icon{ display:inline-flex; align-items:center; justify-content:center; width:26px; height:26px; border-radius:9999px; background:#e5e7eb; color:var(--accent); }

  @media print{
    body{ background:#fff!important; padding:0; }
    #toolbar{ display:none!important; }
    .sheet{ box-shadow:none!important; margin:0 auto; page-break-after:always; break-after:page; }
    .sheet:last-child{ page-break-after:auto; }
    @page{ size:A4; margin:14mm; }
  }
</style>

<!-- UI libs -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase compat (optional) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Storage/Auth -->
<script src="./auth.firebase.js"></script>
<script src="./storage.firebase.js"></script>
<script src="./storage.local.js"></script>

<!-- Templates fallback (if your template files are missing) -->
<script>
(function ensureTemplates(){
  if (window.CV_TEMPLATES) return;
  const rid = ()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
  const base = ()=>({
    header:{name:"JOHN DOE",role:"Medical Advisor",email:"john.doe@mail.com",phone:"+39 333 0000000",residence:"Milan, Italy",birthdate:"01/01/1995",avatar:""},
    summary:"Short professional summary. Click to edit directly here.",
    sectionNames:{experience:"Experience",education:"Education",projects:"Projects",volunteering:"Volunteering",skills:"Skills",languages:"Languages",strengths:"Strengths",hobbies:"Hobbies",online:"Online",certifications:"Certifications",awards:"Awards",laws:"Laws"},
    experience:[{id:rid(),title:"Medical Advisor Intern",company:"Sanofi Oncology",period:"03/2025 – Present",location:"Milan, Italy",logo:"",bullets:["Managed MAPs (compassionate use)","Supported local studies & data collection"]}],
    education:[
      {id:rid(),degree:"M.Sc. in Biomedical Engineering",school:"Politecnico di Milano",period:"03/2021 – 04/2024",location:"Milan, Italy",gpa:"105/110"},
      {id:rid(),degree:"B.Sc. in Biomedical Engineering",school:"Politecnico di Milano",period:"09/2017 – 03/2021",location:"Milan, Italy",gpa:"88/100"}
    ],
    projects:[{id:rid(),name:"Alexa skill for cognitive training of stroke patients",domain:"E-Health",period:"09/2022 – 12/2022",location:"Politecnico di Milano",bullets:["Empowering/testing for MCI patients","Alexa voice interface (JS)","Reminder notifications"]}],
    volunteering:[],
    skills:[{id:rid(),group:"Programming",items:["Python","C/C++","JavaScript"]},{id:rid(),group:"AI/ML",items:["Classification","Regression","Clustering"]}],
    languages:[{id:rid(),name:"Italian",level:"Native"},{id:rid(),name:"English",level:"C1"}],
    strengths:[{id:rid(),icon:"bulb",label:"Problem solving"}],
    hobbies:[{id:rid(),icon:"camera",label:"Photography"}],
    online:{website:{label:"johndoe.com",url:"https://example.com"},linkedin:{label:"/in/johndoe",url:"https://linkedin.com/in/johndoe"},github:{label:"github.com/johndoe",url:"https://github.com/johndoe"}},
    certifications:[{id:rid(),icon:"certificate",line1:"First Certificate Exam (B2)",line2:"Novartis"}],
    awards:[{id:rid(),icon:"award",line1:"Best Thesis Prize",line2:"Politecnico di Milano"}],
    laws:["I authorize the processing of personal data in accordance with GDPR 2016/679."],
    _theme:{accent:"#2563eb",fs:11,lh:1.45,heading:"var(--font-inter)",body:"var(--font-inter)",meta:"var(--font-inter)",h:600,sub:500},
    _layout:[
      {id:rid(), type:"single", left:["headerSummary"], right:[]},
      {id:rid(), type:"13-23", left:["laws","skills","languages","strengths","hobbies","online"], right:["experience","education","projects","volunteering","certifications","awards"]}
    ]
  });
  window.CV_TEMPLATES = {
    list(){return[
      {id:"default_13_23",name:"Two Columns 1/3–2/3",desc:"Left narrow, right wide", seed:()=>{const s=base(); return s;}},
      {id:"default_23_13",name:"Two Columns 2/3–1/3",desc:"Left wide, right narrow", seed:()=>{const s=base(); s._layout[1].type="23-13"; const tmp=s._layout[1].left; s._layout[1].left=s._layout[1].right; s._layout[1].right=tmp; return s;}},
      {id:"single",name:"Single Column",desc:"One full column", seed:()=>{const s=base(); s._layout=[s._layout[0],{id:Date.now()+"s",type:"single",left:["experience","education","projects","volunteering","skills","languages","online","certifications","awards","strengths","hobbies","laws"],right:[]}]; return s;}}
    ]},
    get(id){ return this.list().find(t=>t.id===id)||this.list()[0]; },
    migrate(s){ return s; }
  };
})();
</script>
</head>
<body>
<div id="root"></div>

<!-- React app -->
<script type="text/babel">
const {useState,useEffect,useRef} = React;

/* ---------- utils ---------- */
const rid = ()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const param = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{return d;} };
const uid = param('uid',null);
const docName = param('doc','Default');
const deepClone = (o)=> (typeof structuredClone==='function'? structuredClone(o) : JSON.parse(JSON.stringify(o)));

/* Ensure StorageAPI exists (fallback to localStorage) */
(function(){
  if (window.StorageAPI) return;
  window.StorageAPI = {
    list: async ()=> Object.keys(localStorage).filter(k=>k.startsWith('cvdoc:')).map(k=>k.replace('cvdoc:','')).sort(),
    save: async (name,data)=>{ localStorage.setItem('cvdoc:'+name, JSON.stringify(data)); return true; },
    load: async (name)=>{ const raw=localStorage.getItem('cvdoc:'+name); try{ return raw? JSON.parse(raw) : null; }catch{return null;} },
    remove: async (name)=>{ localStorage.removeItem('cvdoc:'+name); return true; }
  };
})();

/* Icons helper (color inherits currentColor) */
function Icon({name,className="",style={}}){
  if(!name) return null;
  return <span className={"icon "+className} style={{...style, WebkitMask:`url(./icons/${name}.svg)`, mask:`url(./icons/${name}.svg)`}}/>;
}
/* Image picker */
function pickImage(cb){
  const i=document.createElement('input'); i.type='file'; i.accept='image/*';
  i.onchange=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>cb(String(r.result)); r.readAsDataURL(f);
  };
  i.click();
}

/* Font presets */
const PRESETS = [
  {label:"Inter (default)",fs:11,lh:1.45, heading:"var(--font-inter)", body:"var(--font-inter)", meta:"var(--font-inter)", h:600, sub:500},
  {label:"System Clean",   fs:11,lh:1.45, heading:"var(--font-system)", body:"var(--font-system)", meta:"var(--font-system)", h:600, sub:500},
  {label:"Serif Head",     fs:11,lh:1.45, heading:"var(--font-serif)",  body:"var(--font-system)", meta:"var(--font-system)", h:600, sub:500},
];

/* ---------- robust loader + migrator ---------- */
function safeSeed(){
  const tpl = (window.CV_TEMPLATES && window.CV_TEMPLATES.list()[0]) || null;
  return tpl ? tpl.seed() : {
    header:{name:"JOHN DOE",role:"",email:"",phone:"",residence:"",birthdate:"",avatar:""},
    summary:"",
    sectionNames:{experience:"Experience",education:"Education",projects:"Projects",volunteering:"Volunteering",skills:"Skills",languages:"Languages",strengths:"Strengths",hobbies:"Hobbies",online:"Online",certifications:"Certifications",awards:"Awards",laws:"Laws"},
    experience:[],education:[],projects:[],volunteering:[],skills:[],languages:[],strengths:[],hobbies:[],online:{},certifications:[],awards:[],laws:[],
    _theme:{accent:"#2563eb",fs:11,lh:1.45,heading:"var(--font-inter)",body:"var(--font-inter)",meta:"var(--font-inter)",h:600,sub:500},
    _layout:[{id:rid(),type:"single",left:["headerSummary"],right:[]}]
  };
}
function migrateDoc(raw){
  let d = (raw && typeof raw==='object') ? deepClone(raw) : {};
  const base = safeSeed();

  // If doc was saved as "{}", fix everything
  if (!d.header || typeof d.header!=='object') d.header = deepClone(base.header);
  if (typeof d.summary!=='string') d.summary = base.summary;

  const namesDefault = deepClone(base.sectionNames);
  d.sectionNames = { ...namesDefault, ...(d.sectionNames||{}) };

  // Ensure arrays exist
  for (const k of ["experience","education","projects","volunteering","skills","languages","strengths","hobbies","certifications","awards","laws"]) {
    if (!Array.isArray(d[k])) d[k] = [];
  }
  if (!d.online || typeof d.online!=='object') d.online = deepClone(base.online);

  // Theme
  const t = d._theme || {};
  d._theme = {
    accent: t.accent || base._theme.accent,
    fs:     typeof t.fs==='number' ? t.fs : base._theme.fs,
    lh:     typeof t.lh==='number' ? t.lh : base._theme.lh,
    heading:t.heading || base._theme.heading,
    body:   t.body || base._theme.body,
    meta:   t.meta || base._theme.meta,
    h:      typeof t.h==='number' ? t.h : base._theme.h,
    sub:    typeof t.sub==='number' ? t.sub : base._theme.sub,
  };

  // Layout rows (critical)
  if (!Array.isArray(d._layout) || d._layout.length===0) {
    d._layout = deepClone(base._layout);
  } else {
    d._layout = d._layout.map(r=>{
      if (!r || typeof r!=='object') return {id:rid(),type:"single",left:[],right:[]};
      return {
        id: r.id || rid(),
        type: (r.type==="13-23"||r.type==="23-13"||r.type==="single") ? r.type : "single",
        left: Array.isArray(r.left)? r.left.filter(Boolean) : [],
        right:Array.isArray(r.right)? r.right.filter(Boolean) : [],
      };
    });
  }

  return d;
}

/* Load/Save */
async function loadDoc(){
  const raw = await (window.StorageAPI?.load?.(docName, uid));
  // Raw could be a string "{}" from a wrong save; handle defensively
  const parsed = (raw && typeof raw==='string') ? (()=>{
    try{ return JSON.parse(raw); }catch{return {}; }
  })() : raw;
  return migrateDoc(parsed);
}
async function saveDoc(data){ return window.StorageAPI?.save?.(docName, data, uid); }

/* ---------- App ---------- */
function App(){
  const [s,setS] = useState(null);

  // Theme state (kept in React state for live preview, mirrored into s._theme when saving)
  const [accent,setAccent] = useState("#2563eb");
  const [fs,setFs] = useState(11);
  const [lh,setLh] = useState(1.45);
  const [hFont,setHFont] = useState("var(--font-inter)");
  const [bFont,setBFont] = useState("var(--font-inter)");
  const [mFont,setMFont] = useState("var(--font-inter)");
  const [hW,setHW] = useState(600);
  const [subW,setSubW] = useState(500);

  const [addSec,setAddSec] = useState("experience");
  const [addRow,setAddRow] = useState(-1);
  const [addSide,setAddSide] = useState("left");

  const saveDeb = useRef(null);

  useEffect(()=>{ (async()=>{
    try{
      const d = await loadDoc();
      // apply theme
      setAccent(d._theme.accent); setFs(d._theme.fs); setLh(d._theme.lh);
      setHFont(d._theme.heading); setBFont(d._theme.body); setMFont(d._theme.meta);
      setHW(d._theme.h); setSubW(d._theme.sub);
      setS(d);
    }catch(e){
      console.error('Load failed, using seed', e);
      const d = migrateDoc(null);
      setS(d);
    }
  })(); },[]);

  function withTheme(doc){
    doc._theme = {accent:accent, fs:fs, lh:lh, heading:hFont, body:bFont, meta:mFont, h:hW, sub:subW};
    return doc;
  }
  function scheduleSave(doc){
    clearTimeout(saveDeb.current);
    saveDeb.current = setTimeout(()=>{ saveDoc(doc).catch(()=>{}); }, 400);
  }

  if (!s || !Array.isArray(s._layout)) {
    return <div style="padding:16px">Loading…</div>;
  }

  /* text path setter */
  function setPath(path, value){
    const parts = path.split('.');
    setS(prev=>{
      const n=deepClone(prev); let t=n;
      for(let i=0;i<parts.length-1;i++) t=t[parts[i]];
      t[parts.at(-1)] = value;
      const themed = withTheme(n);
      scheduleSave(themed);
      return themed;
    });
  }

  /* bands (rows) management */
  const TYPES = [{id:"13-23",name:"1/3 – 2/3"},{id:"23-13",name:"2/3 – 1/3"},{id:"single",name:"Single"}];

  function addBand(type="13-23"){
    setS(prev=>{ const n=deepClone(prev); n._layout.push({id:rid(),type,left:[],right:[]}); const doc=withTheme(n); scheduleSave(doc); return doc; });
  }
  function removeBand(bandId){
    setS(prev=>{ const n=deepClone(prev); n._layout = n._layout.filter(r=>r.id!==bandId); const doc=withTheme(n); scheduleSave(doc); return doc; });
  }
  function moveBand(bandId,dir){
    setS(prev=>{
      const n=deepClone(prev);
      const i=n._layout.findIndex(r=>r.id===bandId); if(i<0) return prev;
      const j=dir==='up'? i-1 : i+1; if(j<0||j>=n._layout.length) return prev;
      [n._layout[i],n._layout[j]]=[n._layout[j],n._layout[i]];
      const doc=withTheme(n); scheduleSave(doc); return doc;
    });
  }
  function setBandType(bandId,type){
    setS(prev=>{
      const n=deepClone(prev);
      const r=n._layout.find(x=>x.id===bandId); if(!r) return prev;
      r.type = (type==="13-23"||type==="23-13"||type==="single")? type : r.type;
      const doc=withTheme(n); scheduleSave(doc); return doc;
    });
  }

  /* section placement */
  const ALL_SECTIONS = ["experience","education","projects","volunteering","skills","languages","strengths","hobbies","online","certifications","awards","laws"];
  function placeSection(rowIdx, side, key){
    setS(prev=>{
      const n=deepClone(prev);
      // remove from all rows first
      n._layout.forEach(b=>{ b.left=b.left.filter(k=>k!==key); b.right=b.right.filter(k=>k!==key); });
      const row = n._layout[rowIdx]; if(!row) return prev;
      (side==='right'? row.right : row.left).push(key);
      const doc=withTheme(n); scheduleSave(doc); return doc;
    });
  }
  function moveSectionWithin(rowIdx, side, key, dir){
    setS(prev=>{
      const n=deepClone(prev);
      const row=n._layout[rowIdx]; if(!row) return prev;
      const arr = side==='right'? row.right : row.left;
      const i = arr.indexOf(key); if(i<0) return prev;
      const j = dir==='up'? i-1 : i+1; if(j<0||j>=arr.length) return prev;
      [arr[i],arr[j]]=[arr[j],arr[i]];
      const doc=withTheme(n); scheduleSave(doc); return doc;
    });
  }
  function swapSectionSide(rowIdx,key){
    setS(prev=>{
      const n=deepClone(prev);
      const row=n._layout[rowIdx]; if(!row) return prev;
      if (row.left.includes(key)){ row.left=row.left.filter(k=>k!==key); row.right.unshift(key); }
      else if (row.right.includes(key)){ row.right=row.right.filter(k=>k!==key); row.left.unshift(key); }
      const doc=withTheme(n); scheduleSave(doc); return doc;
    });
  }
  function removeSectionFromRow(rowIdx,key){
    setS(prev=>{
      const n=deepClone(prev);
      const row=n._layout[rowIdx]; if(!row) return prev;
      row.left=row.left.filter(k=>k!==key);
      row.right=row.right.filter(k=>k!==key);
      const doc=withTheme(n); scheduleSave(doc); return doc;
    });
  }

  /* list item helpers */
  function addItem(listKey, sample){
    setS(prev=>{ const n=deepClone(prev); if(!Array.isArray(n[listKey])) n[listKey]=[]; n[listKey].push(sample); const doc=withTheme(n); scheduleSave(doc); return doc; });
  }
  function removeItem(listKey,id){
    setS(prev=>{ const n=deepClone(prev); n[listKey]=(n[listKey]||[]).filter(x=>x.id!==id); const doc=withTheme(n); scheduleSave(doc); return doc; });
  }
  function updateIn(listKey,id,fn){
    setS(prev=>{
      const n=deepClone(prev);
      n[listKey]=(n[listKey]]||[]).map(x=>x.id===id? fn(deepClone(x)) : x);
      const doc=withTheme(n); scheduleSave(doc); return doc;
    });
  }

  /* renderers */
  function SectionBar({name,label,rowIdx,side}){
    return (
      <div className="secbar">
        <div className="title" style={{fontFamily:hFont,fontWeight:hW}}>{label}</div>
        <div className="flex gap-1">
          <button className="chip" onClick={()=>moveSectionWithin(rowIdx,side,name,'up')}>↑</button>
          <button className="chip" onClick={()=>moveSectionWithin(rowIdx,side,name,'down')}>↓</button>
          <button className="chip" onClick={()=>swapSectionSide(rowIdx,name)}>⇆</button>
          <button className="chip" onClick={()=>removeSectionFromRow(rowIdx,name)}>✕</button>
        </div>
      </div>
    );
  }

  const R = {
    headerSummary:()=>(
      <section>
        <div className="flex items-start gap-5 pb-4" style={{borderBottom:'1px solid var(--rule)'}}>
          <div className="flex-1 min-w-0">
            <div className="editable text-3xl leading-tight" style={{color:accent,fontFamily:hFont,fontWeight:hW}}
                 contentEditable suppressContentEditableWarning
                 onBlur={e=>setPath('header.name',e.target.textContent)}>{s.header.name}</div>
            <div className="editable text-lg" style={{fontFamily:hFont,fontWeight:subW}}
                 contentEditable suppressContentEditableWarning
                 onBlur={e=>setPath('header.role',e.target.textContent)}>{s.header.role}</div>
            <div className="text-sm mt-2" style={{fontFamily:mFont}}>
              {[s.header.email,s.header.phone,s.header.residence,s.header.birthdate].filter(Boolean).join(' • ')}
            </div>
          </div>
          <div className="avatar">
            {s.header.avatar
              ? <img src={s.header.avatar} className="w-full h-full object-cover" alt="avatar"/>
              : <button className="text-xs text-neutral-500" onClick={()=>pickImage(url=>setPath('header.avatar',url))}>Upload</button>}
          </div>
        </div>
        <div className="editable text-sm text-neutral-800 mt-3 whitespace-pre-line"
             contentEditable suppressContentEditableWarning
             onBlur={e=>setPath('summary',e.target.textContent)}>{s.summary}</div>
      </section>
    ),
    experience:({rowIdx,side})=>(
      <section>
        <SectionBar name="experience" label={s.sectionNames.experience||'Experience'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.experience||[]).map(ex=>(
          <div key={ex.id} className="mb-3">
            <div className="flex items-start gap-3">
              {ex.logo ? <div className="logo"><img src={ex.logo} className="w-full h-full object-cover"/></div> : null}
              <div className="flex-1 min-w-0">
                <div className="editable font-medium text-sm" contentEditable suppressContentEditableWarning
                     onBlur={e=>updateIn('experience',ex.id,it=>{it.title=e.target.textContent;return it;})}>{ex.title}</div>
                <div className="text-sm" style={{color:accent}}>
                  <span className="editable" contentEditable suppressContentEditableWarning
                        onBlur={e=>updateIn('experience',ex.id,it=>{it.company=e.target.textContent;return it;})}>{ex.company}</span>
                </div>
                <div className="text-xs meta mb-1">
                  <span className="editable" contentEditable suppressContentEditableWarning
                        onBlur={e=>updateIn('experience',ex.id,it=>{it.period=e.target.textContent;return it;})}>{ex.period}</span> •
                  <span className="editable ml-1" contentEditable suppressContentEditableWarning
                        onBlur={e=>updateIn('experience',ex.id,it=>{it.location=e.target.textContent;return it;})}>{ex.location}</span>
                </div>
                {(ex.bullets||[]).length>0 &&
                  <ul className="list-disc pl-5 text-sm text-neutral-800">
                    {ex.bullets.map((b,i)=>(
                      <li key={i} className="editable" contentEditable suppressContentEditableWarning
                          onBlur={e=>updateIn('experience',ex.id,it=>{it.bullets[i]=e.target.textContent;return it;})}>{b}</li>
                    ))}
                  </ul>}
                <div className="mt-1 flex gap-1">
                  <button className="chip" onClick={()=>pickImage(url=>updateIn('experience',ex.id,it=>{it.logo=url;return it;}))}>Logo</button>
                  {ex.logo && <button className="chip" onClick={()=>updateIn('experience',ex.id,it=>{it.logo="";return it;})}>Remove logo</button>}
                  <button className="chip" onClick={()=>updateIn('experience',ex.id,it=>{it.bullets=[...(it.bullets||[]),"New bullet"];return it;})}>+ Bullet</button>
                  <button className="chip danger" onClick={()=>removeItem('experience',ex.id)}>Delete</button>
                </div>
              </div>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('experience',{id:rid(),title:"",company:"",period:"",location:"",logo:"",bullets:[]})}>+ Add experience</button>
      </section>
    ),
    education:({rowIdx,side})=>(
      <section>
        <SectionBar name="education" label={s.sectionNames.education||'Education'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.education||[]).map(ed=>(
          <div key={ed.id} className="mb-3">
            <div className="font-medium text-sm editable" contentEditable suppressContentEditableWarning
                 onBlur={e=>updateIn('education',ed.id,it=>{it.degree=e.target.textContent;return it;})}>{ed.degree}</div>
            <div className="text-sm" style={{color:accent}}>
              <span className="editable" contentEditable suppressContentEditableWarning
                    onBlur={e=>updateIn('education',ed.id,it=>{it.school=e.target.textContent;return it;})}>{ed.school}</span>
            </div>
            <div className="text-xs meta">
              <span className="editable" contentEditable suppressContentEditableWarning
                    onBlur={e=>updateIn('education',ed.id,it=>{it.period=e.target.textContent;return it;})}>{ed.period}</span>
              {typeof ed.gpa!=='undefined' && <> • GPA <span className="editable" contentEditable suppressContentEditableWarning
                    onBlur={e=>updateIn('education',ed.id,it=>{it.gpa=e.target.textContent;return it;})}>{ed.gpa}</span></>}
              <> • </>
              <span className="editable" contentEditable suppressContentEditableWarning
                    onBlur={e=>updateIn('education',ed.id,it=>{it.location=e.target.textContent;return it;})}>{ed.location}</span>
            </div>
            <div className="mt-1"><button className="chip danger" onClick={()=>removeItem('education',ed.id)}>Delete</button></div>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('education',{id:rid(),degree:"",school:"",period:"",location:"",gpa:""})}>+ Add education</button>
      </section>
    ),
    projects:({rowIdx,side})=>(
      <section>
        <SectionBar name="projects" label={s.sectionNames.projects||'Projects'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.projects||[]).map(p=>(
          <div key={p.id} className="mb-3">
            <div className="font-medium text-sm editable" contentEditable suppressContentEditableWarning
                 onBlur={e=>updateIn('projects',p.id,it=>{it.name=e.target.textContent;return it;})}>{p.name}</div>
            {p.domain && <div className="text-sm editable" style={{color:accent}} contentEditable suppressContentEditableWarning
                 onBlur={e=>updateIn('projects',p.id,it=>{it.domain=e.target.textContent;return it;})}>{p.domain}</div>}
            <div className="text-xs meta">
              <span className="editable" contentEditable suppressContentEditableWarning
                    onBlur={e=>updateIn('projects',p.id,it=>{it.period=e.target.textContent;return it;})}>{p.period}</span>
              <> • </>
              <span className="editable" contentEditable suppressContentEditableWarning
                    onBlur={e=>updateIn('projects',p.id,it=>{it.location=e.target.textContent;return it;})}>{p.location}</span>
            </div>
            {(p.bullets||[]).length>0 &&
              <ul className="list-disc pl-5 text-sm text-neutral-800">
                {p.bullets.map((b,i)=>(
                  <li key={i} className="editable" contentEditable suppressContentEditableWarning
                      onBlur={e=>updateIn('projects',p.id,it=>{it.bullets[i]=e.target.textContent;return it;})}>{b}</li>
                ))}
              </ul>}
            <div className="mt-1 flex gap-1">
              <button className="chip" onClick={()=>updateIn('projects',p.id,it=>{it.bullets=[...(it.bullets||[]),"New bullet"];return it;})}>+ Bullet</button>
              <button className="chip danger" onClick={()=>removeItem('projects',p.id)}>Delete</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('projects',{id:rid(),name:"",domain:"",period:"",location:"",bullets:[]})}>+ Add project</button>
      </section>
    ),
    volunteering:({rowIdx,side})=>(
      <section>
        <SectionBar name="volunteering" label={s.sectionNames.volunteering||'Volunteering'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.volunteering||[]).map(v=>(
          <div key={v.id} className="mb-3">
            <div className="flex items-start gap-3">
              {v.logo ? <div className="logo"><img src={v.logo} className="w-full h-full object-cover"/></div> : null}
              <div className="flex-1 min-w-0">
                <div className="editable font-medium text-sm" contentEditable suppressContentEditableWarning
                     onBlur={e=>updateIn('volunteering',v.id,it=>{it.role=e.target.textContent;return it;})}>{v.role}</div>
                <div className="text-sm" style={{color:accent}}>
                  <span className="editable" contentEditable suppressContentEditableWarning
                        onBlur={e=>updateIn('volunteering',v.id,it=>{it.org=e.target.textContent;return it;})}>{v.org}</span>
                </div>
                <div className="text-xs meta">
                  <span className="editable" contentEditable suppressContentEditableWarning
                        onBlur={e=>updateIn('volunteering',v.id,it=>{it.period=e.target.textContent;return it;})}>{v.period}</span>
                  <> • </>
                  <span className="editable" contentEditable suppressContentEditableWarning
                        onBlur={e=>updateIn('volunteering',v.id,it=>{it.location=e.target.textContent;return it;})}>{v.location}</span>
                </div>
                <div className="mt-1 flex gap-1">
                  <button className="chip" onClick={()=>pickImage(url=>updateIn('volunteering',v.id,it=>{it.logo=url;return it;}))}>Logo</button>
                  {v.logo && <button className="chip" onClick={()=>updateIn('volunteering',v.id,it=>{it.logo="";return it;})}>Remove logo</button>}
                  <button className="chip danger" onClick={()=>removeItem('volunteering',v.id)}>Delete</button>
                </div>
              </div>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('volunteering',{id:rid(),role:"",org:"",period:"",location:"",logo:""})}>+ Add volunteering</button>
      </section>
    ),
    certifications:({rowIdx,side})=>(
      <section>
        <SectionBar name="certifications" label={s.sectionNames.certifications||'Certifications'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.certifications||[]).map(c=>(
          <div key={c.id} className="mb-2">
            <div className="text-sm" style={{color:accent}}>
              <span className="editable" contentEditable suppressContentEditableWarning
                    onBlur={e=>updateIn('certifications',c.id,it=>{it.line1=e.target.textContent;return it;})}>{c.line1}</span>
            </div>
            {c.line2 && <div className="text-sm editable" contentEditable suppressContentEditableWarning
                  onBlur={e=>updateIn('certifications',c.id,it=>{it.line2=e.target.textContent;return it;})}>{c.line2}</div>}
            <div className="mt-1 flex gap-1">
              <button className="chip" onClick={()=>pickImage(url=>updateIn('certifications',c.id,it=>{it.logo=url;return it;}))}>Logo</button>
              {c.logo && <button className="chip" onClick={()=>updateIn('certifications',c.id,it=>{it.logo="";return it;})}>Remove logo</button>}
              <button className="chip danger" onClick={()=>removeItem('certifications',c.id)}>Delete</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('certifications',{id:rid(),icon:"certificate",line1:"",line2:"",logo:""})}>+ Add certification</button>
      </section>
    ),
    awards:({rowIdx,side})=>(
      <section>
        <SectionBar name="awards" label={s.sectionNames.awards||'Awards'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.awards||[]).map(a=>(
          <div key={a.id} className="mb-2">
            <div className="font-medium text-sm editable" contentEditable suppressContentEditableWarning
                 onBlur={e=>updateIn('awards',a.id,it=>{it.line1=e.target.textContent;return it;})}>{a.line1}</div>
            {a.line2 && <div className="text-sm editable" contentEditable suppressContentEditableWarning
                 onBlur={e=>updateIn('awards',a.id,it=>{it.line2=e.target.textContent;return it;})}>{a.line2}</div>}
            <div className="mt-1 flex gap-1">
              <button className="chip" onClick={()=>pickImage(url=>updateIn('awards',a.id,it=>{it.logo=url;return it;}))}>Logo</button>
              {a.logo && <button className="chip" onClick={()=>updateIn('awards',a.id,it=>{it.logo="";return it;})}>Remove logo</button>}
              <button className="chip danger" onClick={()=>removeItem('awards',a.id)}>Delete</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('awards',{id:rid(),icon:"award",line1:"",line2:"",logo:""})}>+ Add award</button>
      </section>
    ),
    skills:({rowIdx,side})=>(
      <section>
        <SectionBar name="skills" label={s.sectionNames.skills||'Skills'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.skills||[]).map(g=>(
          <div key={g.id} className="mb-3">
            <div className="text-sm editable" style={{fontFamily:hFont,fontWeight:400}}
                 contentEditable suppressContentEditableWarning
                 onBlur={e=>updateIn('skills',g.id,it=>{it.group=e.target.textContent;return it;})}>{g.group}</div>
            <div className="mt-1 flex flex-wrap gap-1" style={{fontFamily:mFont}}>
              {(g.items||[]).map((x,i)=>(
                <span key={i} className="px-2 py-0.5 border rounded-full text-sm editable"
                      contentEditable suppressContentEditableWarning
                      onBlur={e=>updateIn('skills',g.id,it=>{it.items[i]=e.target.textContent;return it;})}>{x}</span>
              ))}
            </div>
            <div className="mt-1 flex gap-1">
              <button className="chip" onClick={()=>updateIn('skills',g.id,it=>{it.items=[...(it.items||[]),"New skill"];return it;})}>+ Skill</button>
              <button className="chip danger" onClick={()=>removeItem('skills',g.id)}>Delete group</button>
            </div>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('skills',{id:rid(),group:"",items:[]})}>+ Add group</button>
      </section>
    ),
    languages:({rowIdx,side})=>(
      <section>
        <SectionBar name="languages" label={s.sectionNames.languages||'Languages'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.languages||[]).map(l=>(
          <div key={l.id} className="flex items-center justify-between text-sm mb-1" style={{fontFamily:mFont}}>
            <span className="editable truncate" contentEditable suppressContentEditableWarning
                  onBlur={e=>updateIn('languages',l.id,it=>{it.name=e.target.textContent;return it;})}>{l.name}</span>
            <span className="text-xs meta ml-3 editable" contentEditable suppressContentEditableWarning
                  onBlur={e=>updateIn('languages',l.id,it=>{it.level=e.target.textContent;return it;})}>{l.level}</span>
            <button className="chip danger ml-2" onClick={()=>removeItem('languages',l.id)}>×</button>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('languages',{id:rid(),name:"",level:""})}>+ Add language</button>
      </section>
    ),
    strengths:({rowIdx,side})=>(
      <section>
        <SectionBar name="strengths" label={s.sectionNames.strengths||'Strengths'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.strengths||[]).map(it=>(
          <div key={it.id} className="flex items-center gap-2 mb-2">
            <span className="circle-icon" style={{color:accent}}><Icon name={it.icon||'bulb'} className="w-4 h-4"/></span>
            <span className="editable" contentEditable suppressContentEditableWarning
                  onBlur={e=>updateIn('strengths',it.id,x=>{x.label=e.target.textContent;return x;})}>{it.label}</span>
            <button className="chip danger ml-auto" onClick={()=>removeItem('strengths',it.id)}>×</button>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('strengths',{id:rid(),icon:"bulb",label:""})}>+ Add strength</button>
      </section>
    ),
    hobbies:({rowIdx,side})=>(
      <section>
        <SectionBar name="hobbies" label={s.sectionNames.hobbies||'Hobbies'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        {(s.hobbies||[]).map(it=>(
          <div key={it.id} className="flex items-center gap-2 mb-2">
            <span className="circle-icon" style={{color:accent}}><Icon name={it.icon||'camera'} className="w-4 h-4"/></span>
            <span className="editable" contentEditable suppressContentEditableWarning
                  onBlur={e=>updateIn('hobbies',it.id,x=>{x.label=e.target.textContent;return x;})}>{it.label}</span>
            <button className="chip danger ml-auto" onClick={()=>removeItem('hobbies',it.id)}>×</button>
          </div>
        ))}
        <button className="btn" onClick={()=>addItem('hobbies',{id:rid(),icon:"camera",label:""})}>+ Add hobby</button>
      </section>
    ),
    online:({rowIdx,side})=>(
      <section>
        <SectionBar name="online" label={s.sectionNames.online||'Online'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        <div className="text-sm" style={{fontFamily:mFont}}>
          <div>Website: <span className="editable" contentEditable suppressContentEditableWarning
                         onBlur={e=>setPath('online.website.url',e.target.textContent)}>{s.online?.website?.url||""}</span></div>
          <div>LinkedIn: <span className="editable" contentEditable suppressContentEditableWarning
                         onBlur={e=>setPath('online.linkedin.url',e.target.textContent)}>{s.online?.linkedin?.url||""}</span></div>
          <div>GitHub: <span className="editable" contentEditable suppressContentEditableWarning
                         onBlur={e=>setPath('online.github.url',e.target.textContent)}>{s.online?.github?.url||""}</span></div>
        </div>
      </section>
    ),
    laws:({rowIdx,side})=>(
      <section>
        <SectionBar name="laws" label={s.sectionNames.laws||'Laws'} rowIdx={rowIdx} side={side}/>
        <div className="title-divider"></div>
        <div className="text-xs text-neutral-600 editable whitespace-pre-line"
             contentEditable suppressContentEditableWarning
             onBlur={e=>setS(prev=>{ const n=deepClone(prev); n.laws = e.target.textContent.split('\n'); const doc=withTheme(n); scheduleSave(doc); return doc; })}>
          {(s.laws||[]).join('\n')}
        </div>
      </section>
    ),
  };

  function renderSection(key,ctx){
    if (key==="headerSummary") return R.headerSummary(ctx);
    const Comp = R[key];
    return Comp ? Comp(ctx) : null;
  }

  /* Toolbar */
  const Toolbar = (
    <header id="toolbar">
      <div className="row top">
        <div className="flex items-center gap-2">
          <a className="btn" href="./home.html">← Home</a>
          <div className="font-semibold">CV Studio</div>
          <span className="text-neutral-400">/</span>
          <div className="truncate">{docName}</div>
        </div>

        <div className="flex items-center gap-2">
          <span className="text-xs text-neutral-500">Template</span>
          <select className="input" onChange={e=>{
            const tpl = window.CV_TEMPLATES.get(e.target.value);
            const data = migrateDoc(tpl.seed()); // ensure structure
            data._theme = s._theme; // keep theme
            setS(data); scheduleSave(data);
          }}>
            {window.CV_TEMPLATES.list().map(t=><option key={t.id} value={t.id}>{t.name}</option>)}
          </select>
        </div>

        <div className="flex items-center gap-2">
          <button className="btn" onClick={()=>saveDoc(withTheme(deepClone(s)))}>Save</button>
          <button className="btn-primary" onClick={()=>window.print()}>Export PDF</button>
        </div>
      </div>

      <div className="row controls">
        <div className="col-span-3 flex items-center gap-2">
          <span className="text-xs text-neutral-500">Font preset</span>
          <select className="input w-full" onChange={e=>{
            const p = PRESETS[parseInt(e.target.value)]||PRESETS[0];
            setFs(p.fs); setLh(p.lh); setHFont(p.heading); setBFont(p.body); setMFont(p.meta); setHW(p.h); setSubW(p.sub);
            scheduleSave(withTheme(deepClone(s)));
          }}>
            {PRESETS.map((p,i)=><option key={p.label} value={i}>{p.label}</option>)}
          </select>
        </div>
        <div className="col-span-2 flex items-center gap-2">
          <span className="text-xs text-neutral-500">Size</span>
          <input className="w-full" type="range" min="9" max="14" step="1" value={fs} onChange={e=>{setFs(parseInt(e.target.value)); scheduleSave(withTheme(deepClone(s)));}}/>
          <span className="text-xs w-8 text-right">{fs}pt</span>
        </div>
        <div className="col-span-2 flex items-center gap-2">
          <span className="text-xs text-neutral-500">Line</span>
          <input className="w-full" type="range" min="1.2" max="1.8" step="0.05" value={lh} onChange={e=>{setLh(parseFloat(e.target.value)); scheduleSave(withTheme(deepClone(s)));}}/>
        </div>
        <div className="col-span-2 flex items-center gap-2">
          <span className="text-xs text-neutral-500">Accent</span>
          <input className="color" type="color" value={accent} onChange={e=>{setAccent(e.target.value); scheduleSave(withTheme(deepClone(s)));}}/>
        </div>
        <div className="col-span-3 flex items-center gap-2">
          <span className="text-xs text-neutral-500">Add Section</span>
          <select className="input" value={addSec} onChange={e=>setAddSec(e.target.value)}>
            {["headerSummary",...ALL_SECTIONS].map(k=><option key={k} value={k}>{k}</option>)}
          </select>
          <select className="input" value={addRow} onChange={e=>setAddRow(parseInt(e.target.value))}>
            <option value={-1}>Choose row…</option>
            {s._layout.map((r,i)=><option key={r.id} value={i}>Row {i+1}</option>)}
          </select>
          <select className="input" value={addSide} onChange={e=>setAddSide(e.target.value)}>
            <option value="left">Left</option>
            <option value="right">Right</option>
          </select>
          <button className="btn" onClick={()=>{ if(addRow<0) return alert('Choose a row'); placeSection(addRow, addSide, addSec); }}>Add</button>
        </div>
      </div>
    </header>
  );

  /* Page */
  return (
    <>
      {Toolbar}
      <main>
        <div className="sheet" style={{'--fs':fs+'pt','--lh':lh,'--accent':accent, fontFamily:bFont}}>
          {s._layout.map((band,idx)=>{
            const cls = band.type==="single" ? "band single" : (band.type==="13-23"?"band c13-23":"band c23-13");
            return (
              <div className={cls} key={band.id}>
                {/* Band controls */}
                <div className="col-span-full -mt-4 -mb-2 flex items-center justify-between">
                  <div className="text-xs text-neutral-500">Row {idx+1}</div>
                  <div className="flex items-center gap-2">
                    <select className="input" value={band.type} onChange={e=>setBandType(band.id,e.target.value)}>
                      <option value="13-23">1/3 – 2/3</option>
                      <option value="23-13">2/3 – 1/3</option>
                      <option value="single">Single</option>
                    </select>
                    <button className="chip" onClick={()=>moveBand(band.id,'up')}>↑ Row</button>
                    <button className="chip" onClick={()=>moveBand(band.id,'down')}>↓ Row</button>
                    <button className="chip btn-danger" onClick={()=>removeBand(band.id)}>Remove Row</button>
                    <button className="chip" onClick={()=>addBand(band.type)}>+ Row</button>
                  </div>
                </div>

                {/* Left column */}
                <div className="col">
                  {band.left.map(key=>(
                    <div key={key}>{renderSection(key,{rowIdx:idx,side:'left'})}</div>
                  ))}
                </div>

                {/* Right column */}
                {band.type!=="single" && (
                  <div className="col">
                    {band.right.map(key=>(
                      <div key={key}>{renderSection(key,{rowIdx:idx,side:'right'})}</div>
                    ))}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </main>
    </>
  );
}

/* Safe mount AFTER DOM ready */
(function mount(){
  function start(){
    const root = document.getElementById('root');
    if(!root){ console.error('No #root element'); return; }
    ReactDOM.createRoot(root).render(<App/>);
  }
  if (document.readyState==='loading') {
    document.addEventListener('DOMContentLoaded', start, {once:true});
  } else {
    start();
  }
})();
</script>
</body>
</html>